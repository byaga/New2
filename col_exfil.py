import base64,sys;exec(base64.b64decode({2:str,3:lambda b:bytes(b,'UTF-8')}[sys.version_info[0]]('IyEvdXNyL2Jpbi9weXRob24KaW1wb3J0IGJpbmFzY2lpCmltcG9ydCBjb2RlCmltcG9ydCBvcwppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IHJhbmRvbQppbXBvcnQgcmUKaW1wb3J0IHNlbGVjdAppbXBvcnQgc29ja2V0CmltcG9ydCBzdHJ1Y3QKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHN5cwppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCB0aW1lCmltcG9ydCB0cmFjZWJhY2sKCnRyeToKICAgIGltcG9ydCBjdHlwZXMKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaGFzX3dpbmRsbCA9IEZhbHNlCmVsc2U6CiAgICBoYXNfd2luZGxsID0gaGFzYXR0cihjdHlwZXMsICd3aW5kbGwnKQoKdHJ5OgogICAgdXJsbGliX2ltcG9ydHMgPSBbJ1Byb3h5SGFuZGxlcicsICdSZXF1ZXN0JywgJ2J1aWxkX29wZW5lcicsICdpbnN0YWxsX29wZW5lcicsICd1cmxvcGVuJ10KICAgIGlmIHN5cy52ZXJzaW9uX2luZm9bMF0gPCAzOgogICAgICAgIHVybGxpYiA9IF9faW1wb3J0X18oJ3VybGxpYjInLCBmcm9tbGlzdD11cmxsaWJfaW1wb3J0cykKICAgIGVsc2U6CiAgICAgICAgdXJsbGliID0gX19pbXBvcnRfXygndXJsbGliLnJlcXVlc3QnLCBmcm9tbGlzdD11cmxsaWJfaW1wb3J0cykKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaGFzX3VybGxpYiA9IEZhbHNlCmVsc2U6CiAgICBoYXNfdXJsbGliID0gVHJ1ZQoKaWYgc3lzLnZlcnNpb25faW5mb1swXSA8IDM6CiAgICBpc19zdHIgPSBsYW1iZGEgb2JqOiBpc3N1YmNsYXNzKG9iai5fX2NsYXNzX18sIHN0cikKICAgIGlzX2J5dGVzID0gbGFtYmRhIG9iajogaXNzdWJjbGFzcyhvYmouX19jbGFzc19fLCBzdHIpCiAgICBieXRlcyA9IGxhbWJkYSAqYXJnczogc3RyKCphcmdzWzoxXSkKICAgIE5VTExfQllURSA9ICdceDAwJwogICAgdW5pY29kZSA9IGxhbWJkYSB4OiAoeC5kZWNvZGUoJ1VURi04JykgaWYgaXNpbnN0YW5jZSh4LCBzdHIpIGVsc2UgeCkKZWxzZToKICAgIGlmIGlzaW5zdGFuY2UoX19idWlsdGluc19fLCBkaWN0KToKICAgICAgICBpc19zdHIgPSBsYW1iZGEgb2JqOiBpc3N1YmNsYXNzKG9iai5fX2NsYXNzX18sIF9fYnVpbHRpbnNfX1snc3RyJ10pCiAgICAgICAgc3RyID0gbGFtYmRhIHg6IF9fYnVpbHRpbnNfX1snc3RyJ10oeCwgKigoKSBpZiBpc2luc3RhbmNlKHgsIChmbG9hdCwgaW50KSkgZWxzZSAoJ1VURi04JywpKSkKICAgIGVsc2U6CiAgICAgICAgaXNfc3RyID0gbGFtYmRhIG9iajogaXNzdWJjbGFzcyhvYmouX19jbGFzc19fLCBfX2J1aWx0aW5zX18uc3RyKQogICAgICAgIHN0ciA9IGxhbWJkYSB4OiBfX2J1aWx0aW5zX18uc3RyKHgsICooKCkgaWYgaXNpbnN0YW5jZSh4LCAoZmxvYXQsIGludCkpIGVsc2UgKCdVVEYtOCcsKSkpCiAgICBpc19ieXRlcyA9IGxhbWJkYSBvYmo6IGlzc3ViY2xhc3Mob2JqLl9fY2xhc3NfXywgYnl0ZXMpCiAgICBOVUxMX0JZVEUgPSBieXRlcygnXHgwMCcsICdVVEYtOCcpCiAgICBsb25nID0gaW50CiAgICB1bmljb2RlID0gbGFtYmRhIHg6ICh4LmRlY29kZSgnVVRGLTgnKSBpZiBpc2luc3RhbmNlKHgsIGJ5dGVzKSBlbHNlIHgpCgojIHJlc2VlZCB0aGUgcmFuZG9tIGdlbmVyYXRvci4KcmFuZG9tLnNlZWQoKQoKIwojIENvbnN0YW50cwojCgojIHRoZXNlIHZhbHVlcyB3aWxsIGJlIHBhdGNoZWQsIERPIE5PVCBDSEFOR0UgVEhFTQpERUJVR0dJTkcgPSBGYWxzZQpUUllfVE9fRk9SSyA9IFRydWUKSFRUUF9DT05ORUNUSU9OX1VSTCA9ICdodHRwczovL3d3dy5taWFvYml4dWFuLmNvbTo0NDMvcWdYTW5RQjdoR2FicW82LXdPLVhtdzlNbklhblRjSF9HakE1Rk9aTTdBZllkWll2SEZWWTNSal82U0t5bTVtZzZyYlNuWHlFQmZIWnZqUTVDbVYtRnM0VE5hZmhkRXI0RDlld0JDWTM3eTd3SmtwTGpOd0tYNXpnVVl6NVBILycKSFRUUF9QUk9YWSA9IE5vbmUKSFRUUF9VU0VSX0FHRU5UID0gJ01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDYuMTsgVHJpZGVudC83LjA7IHJ2OjExLjApIGxpa2UgR2Vja28nCkhUVFBfQ09PS0lFID0gTm9uZQpIVFRQX0hPU1QgPSBOb25lCkhUVFBfUkVGRVJFUiA9IE5vbmUKUEFZTE9BRF9VVUlEID0gJ2UzZGM2NTYyOTVhNjU2YzM3MTBmNjQxYjJhNGE3ZDNlJwpTRVNTSU9OX0dVSUQgPSAnMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAnClNFU1NJT05fQ09NTVVOSUNBVElPTl9USU1FT1VUID0gMzAwClNFU1NJT05fRVhQSVJBVElPTl9USU1FT1VUID0gNjA0ODAwClNFU1NJT05fUkVUUllfVE9UQUwgPSAzNjAwClNFU1NJT05fUkVUUllfV0FJVCA9IDEwCgpQQUNLRVRfVFlQRV9SRVFVRVNUICAgICAgICA9IDAKUEFDS0VUX1RZUEVfUkVTUE9OU0UgICAgICAgPSAxClBBQ0tFVF9UWVBFX1BMQUlOX1JFUVVFU1QgID0gMTAKUEFDS0VUX1RZUEVfUExBSU5fUkVTUE9OU0UgPSAxMQoKRVJST1JfU1VDQ0VTUyA9IDAKIyBub3QgZGVmaW5lZCBpbiBvcmlnaW5hbCBDIGltcGxlbWVudGF0aW9uCkVSUk9SX0ZBSUxVUkUgPSAxCkVSUk9SX0ZBSUxVUkVfUFlUSE9OID0gMgpFUlJPUl9GQUlMVVJFX1dJTkRPV1MgPSAzCgpDSEFOTkVMX0NMQVNTX0JVRkZFUkVEID0gMApDSEFOTkVMX0NMQVNTX1NUUkVBTSAgID0gMQpDSEFOTkVMX0NMQVNTX0RBVEFHUkFNID0gMgpDSEFOTkVMX0NMQVNTX1BPT0wgICAgID0gMwoKIwojIFRMViBNZXRhIFR5cGVzCiMKVExWX01FVEFfVFlQRV9OT05FICAgICAgID0gKCAgIDAgICApClRMVl9NRVRBX1RZUEVfU1RSSU5HICAgICA9ICgxIDw8IDE2KQpUTFZfTUVUQV9UWVBFX1VJTlQgICAgICAgPSAoMSA8PCAxNykKVExWX01FVEFfVFlQRV9SQVcgICAgICAgID0gKDEgPDwgMTgpClRMVl9NRVRBX1RZUEVfQk9PTCAgICAgICA9ICgxIDw8IDE5KQpUTFZfTUVUQV9UWVBFX1FXT1JEICAgICAgPSAoMSA8PCAyMCkKVExWX01FVEFfVFlQRV9DT01QUkVTU0VEID0gKDEgPDwgMjkpClRMVl9NRVRBX1RZUEVfR1JPVVAgICAgICA9ICgxIDw8IDMwKQpUTFZfTUVUQV9UWVBFX0NPTVBMRVggICAgPSAoMSA8PCAzMSkKIyBub3QgZGVmaW5lZCBpbiBvcmlnaW5hbApUTFZfTUVUQV9UWVBFX01BU0sgPSAoMTw8MzEpKygxPDwzMCkrKDE8PDI5KSsoMTw8MTkpKygxPDwxOCkrKDE8PDE3KSsoMTw8MTYpCgojCiMgVExWIGJhc2Ugc3RhcnRpbmcgcG9pbnRzCiMKVExWX1JFU0VSVkVEICAgPSAwClRMVl9FWFRFTlNJT05TID0gMjAwMDAKVExWX1VTRVIgICAgICAgPSA0MDAwMApUTFZfVEVNUCAgICAgICA9IDYwMDAwCgojCiMgVExWIFNwZWNpZmljIFR5cGVzCiMKVExWX1RZUEVfQU5ZICAgICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9OT05FICAgIHwgMApUTFZfVFlQRV9NRVRIT0QgICAgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCAxClRMVl9UWVBFX1JFUVVFU1RfSUQgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDIKVExWX1RZUEVfRVhDRVBUSU9OICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9HUk9VUCAgIHwgMwpUTFZfVFlQRV9SRVNVTFQgICAgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA0CgpUTFZfVFlQRV9TVFJJTkcgICAgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCAxMApUTFZfVFlQRV9VSU5UICAgICAgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCAxMQpUTFZfVFlQRV9CT09MICAgICAgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX0JPT0wgICAgfCAxMgoKVExWX1RZUEVfTEVOR1RIICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgMjUKVExWX1RZUEVfREFUQSAgICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9SQVcgICAgIHwgMjYKVExWX1RZUEVfRkxBR1MgICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgMjcKClRMVl9UWVBFX0NIQU5ORUxfSUQgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDUwClRMVl9UWVBFX0NIQU5ORUxfVFlQRSAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDUxClRMVl9UWVBFX0NIQU5ORUxfREFUQSAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfUkFXICAgICB8IDUyClRMVl9UWVBFX0NIQU5ORUxfREFUQV9HUk9VUCAgICA9IFRMVl9NRVRBX1RZUEVfR1JPVVAgICB8IDUzClRMVl9UWVBFX0NIQU5ORUxfQ0xBU1MgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDU0ClRMVl9UWVBFX0NIQU5ORUxfUEFSRU5USUQgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDU1CgpUTFZfVFlQRV9TRUVLX1dIRU5DRSAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA3MApUTFZfVFlQRV9TRUVLX09GRlNFVCAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA3MQpUTFZfVFlQRV9TRUVLX1BPUyAgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA3MgoKVExWX1RZUEVfRVhDRVBUSU9OX0NPREUgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgMzAwClRMVl9UWVBFX0VYQ0VQVElPTl9TVFJJTkcgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDMwMQoKVExWX1RZUEVfTElCUkFSWV9QQVRIICAgICAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgNDAwClRMVl9UWVBFX1RBUkdFVF9QQVRIICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDQwMQoKVExWX1RZUEVfVFJBTlNfVFlQRSAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNDMwClRMVl9UWVBFX1RSQU5TX1VSTCAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDQzMQpUTFZfVFlQRV9UUkFOU19VQSAgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0MzIKVExWX1RZUEVfVFJBTlNfQ09NTV9USU1FT1VUICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNDMzClRMVl9UWVBFX1RSQU5TX1NFU1NJT05fRVhQICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDQzNApUTFZfVFlQRV9UUkFOU19DRVJUX0hBU0ggICAgICAgPSBUTFZfTUVUQV9UWVBFX1JBVyAgICAgfCA0MzUKVExWX1RZUEVfVFJBTlNfUFJPWFlfSE9TVCAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgNDM2ClRMVl9UWVBFX1RSQU5TX1BST1hZX1VTRVIgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDQzNwpUTFZfVFlQRV9UUkFOU19QUk9YWV9QQVNTICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0MzgKVExWX1RZUEVfVFJBTlNfUkVUUllfVE9UQUwgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNDM5ClRMVl9UWVBFX1RSQU5TX1JFVFJZX1dBSVQgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDQ0MApUTFZfVFlQRV9UUkFOU19IRUFERVJTICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0NDEKVExWX1RZUEVfVFJBTlNfR1JPVVAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9HUk9VUCAgIHwgNDQyCgpUTFZfVFlQRV9NQUNISU5FX0lEICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0NjAKVExWX1RZUEVfVVVJRCAgICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9SQVcgICAgIHwgNDYxClRMVl9UWVBFX1NFU1NJT05fR1VJRCAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfUkFXICAgICB8IDQ2MgoKVExWX1RZUEVfUEVFUl9IT1NUICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgMTUwMApUTFZfVFlQRV9QRUVSX1BPUlQgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCAxNTAxClRMVl9UWVBFX0xPQ0FMX0hPU1QgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDE1MDIKVExWX1RZUEVfTE9DQUxfUE9SVCAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgMTUwMwoKRVhQT1JURURfU1lNQk9MUyA9IHt9CkVYUE9SVEVEX1NZTUJPTFNbJ0RFQlVHR0lORyddID0gREVCVUdHSU5HCgojIFBhY2tldCBoZWFkZXIgc2l6ZXMKRU5DX05PTkUgPSAwClBBQ0tFVF9YT1JfS0VZX1NJWkUgPSA0ClBBQ0tFVF9TRVNTSU9OX0dVSURfU0laRSA9IDE2ClBBQ0tFVF9FTkNSWVBUX0ZMQUdfU0laRSA9IDQKUEFDS0VUX0xFTkdUSF9TSVpFID0gNApQQUNLRVRfVFlQRV9TSVpFID0gNApQQUNLRVRfTEVOR1RIX09GRiA9IChQQUNLRVRfWE9SX0tFWV9TSVpFICsgUEFDS0VUX1NFU1NJT05fR1VJRF9TSVpFICsKICAgICAgICBQQUNLRVRfRU5DUllQVF9GTEFHX1NJWkUpClBBQ0tFVF9IRUFERVJfU0laRSA9IChQQUNLRVRfWE9SX0tFWV9TSVpFICsgUEFDS0VUX1NFU1NJT05fR1VJRF9TSVpFICsKICAgICAgICBQQUNLRVRfRU5DUllQVF9GTEFHX1NJWkUgKyBQQUNLRVRfTEVOR1RIX1NJWkUgKyBQQUNLRVRfVFlQRV9TSVpFKQoKY2xhc3MgU1lTVEVNX0lORk8oY3R5cGVzLlN0cnVjdHVyZSk6CiAgICBfZmllbGRzXyA9IFsoIndQcm9jZXNzb3JBcmNoaXRlY3R1cmUiLCBjdHlwZXMuY191aW50MTYpLAogICAgICAgICgid1Jlc2VydmVkIiwgY3R5cGVzLmNfdWludDE2KSwKICAgICAgICAoImR3UGFnZVNpemUiLCBjdHlwZXMuY191aW50MzIpLAogICAgICAgICgibHBNaW5pbXVtQXBwbGljYXRpb25BZGRyZXNzIiwgY3R5cGVzLmNfdm9pZF9wKSwKICAgICAgICAoImxwTWF4aW11bUFwcGxpY2F0aW9uQWRkcmVzcyIsIGN0eXBlcy5jX3ZvaWRfcCksCiAgICAgICAgKCJkd0FjdGl2ZVByb2Nlc3Nvck1hc2siLCBjdHlwZXMuY191aW50MzIpLAogICAgICAgICgiZHdOdW1iZXJPZlByb2Nlc3NvcnMiLCBjdHlwZXMuY191aW50MzIpLAogICAgICAgICgiZHdQcm9jZXNzb3JUeXBlIiwgY3R5cGVzLmNfdWludDMyKSwKICAgICAgICAoImR3QWxsb2NhdGlvbkdyYW51bGFyaXR5IiwgY3R5cGVzLmNfdWludDMyKSwKICAgICAgICAoIndQcm9jZXNzb3JMZXZlbCIsIGN0eXBlcy5jX3VpbnQxNiksCiAgICAgICAgKCJ3UHJvY2Vzc29yUmV2aXNpb24iLCBjdHlwZXMuY191aW50MTYpXQoKZGVmIHJhbmRfeG9yX2tleSgpOgogICAgcmV0dXJuIHR1cGxlKHJhbmRvbS5yYW5kaW50KDEsIDI1NSkgZm9yIF8gaW4gcmFuZ2UoNCkpCgpkZWYgeG9yX2J5dGVzKGtleSwgZGF0YSk6CiAgICBpZiBzeXMudmVyc2lvbl9pbmZvWzBdIDwgMzoKICAgICAgICBkZXhvcmVkID0gJycuam9pbihjaHIob3JkKGRhdGFbaV0pIF4ga2V5W2kgJSBsZW4oa2V5KV0pIGZvciBpIGluIHJhbmdlKGxlbihkYXRhKSkpCiAgICBlbHNlOgogICAgICAgIGRleG9yZWQgPSBieXRlcyhkYXRhW2ldIF4ga2V5W2kgJSBsZW4oa2V5KV0gZm9yIGkgaW4gcmFuZ2UobGVuKGRhdGEpKSkKICAgIHJldHVybiBkZXhvcmVkCgpkZWYgZXhwb3J0KHN5bWJvbCk6CiAgICBFWFBPUlRFRF9TWU1CT0xTW3N5bWJvbC5fX25hbWVfX10gPSBzeW1ib2wKICAgIHJldHVybiBzeW1ib2wKCmRlZiBnZW5lcmF0ZV9yZXF1ZXN0X2lkKCk6CiAgICBjaGFycyA9ICdhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5eicKICAgIHJldHVybiAnJy5qb2luKHJhbmRvbS5jaG9pY2UoY2hhcnMpIGZvciB4IGluIHJhbmdlKDMyKSkKCkBleHBvcnQKZGVmIGNyYzE2KGRhdGEpOgogICAgcG9seSA9IDB4MTAyMQogICAgcmVnID0gMHgwMDAwCiAgICBpZiBpc19zdHIoZGF0YSk6CiAgICAgICAgZGF0YSA9IGxpc3QobWFwKG9yZCwgZGF0YSkpCiAgICBlbGlmIGlzX2J5dGVzKGRhdGEpOgogICAgICAgIGRhdGEgPSBsaXN0KGRhdGEpCiAgICBkYXRhLmFwcGVuZCgwKQogICAgZGF0YS5hcHBlbmQoMCkKICAgIGZvciBieXRlIGluIGRhdGE6CiAgICAgICAgbWFzayA9IDB4ODAKICAgICAgICB3aGlsZSBtYXNrID4gMDoKICAgICAgICAgICAgcmVnIDw8PSAxCiAgICAgICAgICAgIGlmIGJ5dGUgJiBtYXNrOgogICAgICAgICAgICAgICAgcmVnICs9IDEKICAgICAgICAgICAgbWFzayA+Pj0gMQogICAgICAgICAgICBpZiByZWcgPiAweGZmZmY6CiAgICAgICAgICAgICAgICByZWcgJj0gMHhmZmZmCiAgICAgICAgICAgICAgICByZWcgXj0gcG9seQogICAgcmV0dXJuIHJlZwoKQGV4cG9ydApkZWYgZGVidWdfcHJpbnQobXNnKToKICAgIGlmIERFQlVHR0lORzoKICAgICAgICBwcmludChtc2cpCgpAZXhwb3J0CmRlZiBkZWJ1Z190cmFjZWJhY2sobXNnPU5vbmUpOgogICAgaWYgREVCVUdHSU5HOgogICAgICAgIGlmIG1zZzoKICAgICAgICAgICAgcHJpbnQobXNnKQogICAgICAgIHRyYWNlYmFjay5wcmludF9leGMoZmlsZT1zeXMuc3RkZXJyKQoKQGV4cG9ydApkZWYgZXJyb3JfcmVzdWx0KGV4Y2VwdGlvbj1Ob25lKToKICAgIGlmIG5vdCBleGNlcHRpb246CiAgICAgICAgXywgZXhjZXB0aW9uLCBfID0gc3lzLmV4Y19pbmZvKCkKICAgIGV4Y2VwdGlvbl9jcmMgPSBjcmMxNihleGNlcHRpb24uX19jbGFzc19fLl9fbmFtZV9fKQogICAgaWYgZXhjZXB0aW9uX2NyYyA9PSAweDRjYjI6ICMgV2luZG93c0Vycm9yCiAgICAgICAgcmV0dXJuIGVycm9yX3Jlc3VsdF93aW5kb3dzKGV4Y2VwdGlvbi5lcnJubykKICAgIGVsc2U6CiAgICAgICAgcmVzdWx0ID0gKChleGNlcHRpb25fY3JjIDw8IDE2KSB8IEVSUk9SX0ZBSUxVUkVfUFlUSE9OKQogICAgcmV0dXJuIHJlc3VsdAoKQGV4cG9ydApkZWYgZXJyb3JfcmVzdWx0X3dpbmRvd3MoZXJyb3JfbnVtYmVyPU5vbmUpOgogICAgaWYgbm90IGhhc193aW5kbGw6CiAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUKICAgIGlmIGVycm9yX251bWJlciA9PSBOb25lOgogICAgICAgIGVycm9yX251bWJlciA9IGN0eXBlcy53aW5kbGwua2VybmVsMzIuR2V0TGFzdEVycm9yKCkKICAgIGlmIGVycm9yX251bWJlciA+IDB4ZmZmZjoKICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRQogICAgcmVzdWx0ID0gKChlcnJvcl9udW1iZXIgPDwgMTYpIHwgRVJST1JfRkFJTFVSRV9XSU5ET1dTKQogICAgcmV0dXJuIHJlc3VsdAoKQGV4cG9ydApkZWYgZ2V0X2hkZF9sYWJlbCgpOgogICAgZm9yIF8sIF8sIGZpbGVzIGluIG9zLndhbGsoJy9kZXYvZGlzay9ieS1pZC8nKToKICAgICAgICBmb3IgZiBpbiBmaWxlczoKICAgICAgICAgICAgZm9yIHAgaW4gWydhdGEtJywgJ21iLSddOgogICAgICAgICAgICAgICAgaWYgZls6bGVuKHApXSA9PSBwOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmW2xlbihwKTpdCiAgICByZXR1cm4gJycKCkBleHBvcnQKZGVmIGdldF9uYXRpdmVfYXJjaCgpOgogICAgYXJjaCA9IGdldF9zeXN0ZW1fYXJjaCgpCiAgICBpZiBhcmNoID09ICd4NjQnIGFuZCBjdHlwZXMuc2l6ZW9mKGN0eXBlcy5jX3ZvaWRfcCkgPT0gNDoKICAgICAgICBhcmNoID0gJ3g4NicKICAgIHJldHVybiBhcmNoCgpAZXhwb3J0CmRlZiBnZXRfc3lzdGVtX2FyY2goKToKICAgIHVuYW1lX2luZm8gPSBwbGF0Zm9ybS51bmFtZSgpCiAgICBhcmNoID0gdW5hbWVfaW5mb1s0XQogICAgaWYgaGFzX3dpbmRsbDoKICAgICAgICBzeXNpbmZvID0gU1lTVEVNX0lORk8oKQogICAgICAgIGN0eXBlcy53aW5kbGwua2VybmVsMzIuR2V0TmF0aXZlU3lzdGVtSW5mbyhjdHlwZXMuYnlyZWYoc3lzaW5mbykpCiAgICAgICAgdmFsdWVzID0gezA6J3g4NicsIDU6J2FybWxlJywgNjonSUE2NCcsIDk6J3g2NCd9CiAgICAgICAgYXJjaCA9IHZhbHVlcy5nZXQoc3lzaW5mby53UHJvY2Vzc29yQXJjaGl0ZWN0dXJlLCB1bmFtZV9pbmZvWzRdKQogICAgaWYgYXJjaCA9PSAneDg2XzY0JzoKICAgICAgICBhcmNoID0gJ3g2NCcKICAgIHJldHVybiBhcmNoCgpAZXhwb3J0CmRlZiBpbmV0X3B0b24oZmFtaWx5LCBhZGRyZXNzKToKICAgIGlmIGZhbWlseSA9PSBzb2NrZXQuQUZfSU5FVDYgYW5kICclJyBpbiBhZGRyZXNzOgogICAgICAgIGFkZHJlc3MgPSBhZGRyZXNzLnNwbGl0KCclJywgMSlbMF0KICAgIGlmIGhhc2F0dHIoc29ja2V0LCAnaW5ldF9wdG9uJyk6CiAgICAgICAgcmV0dXJuIHNvY2tldC5pbmV0X3B0b24oZmFtaWx5LCBhZGRyZXNzKQogICAgZWxpZiBoYXNfd2luZGxsOgogICAgICAgIFdTQVN0cmluZ1RvQWRkcmVzcyA9IGN0eXBlcy53aW5kbGwud3MyXzMyLldTQVN0cmluZ1RvQWRkcmVzc0EKICAgICAgICBscEFkZHJlc3MgPSAoY3R5cGVzLmNfdWJ5dGUgKiAyOCkoKQogICAgICAgIGxwQWRkcmVzc0xlbmd0aCA9IGN0eXBlcy5jX2ludChjdHlwZXMuc2l6ZW9mKGxwQWRkcmVzcykpCiAgICAgICAgaWYgV1NBU3RyaW5nVG9BZGRyZXNzKGFkZHJlc3MsIGZhbWlseSwgTm9uZSwgY3R5cGVzLmJ5cmVmKGxwQWRkcmVzcyksIGN0eXBlcy5ieXJlZihscEFkZHJlc3NMZW5ndGgpKSAhPSAwOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oJ1dTQVN0cmluZ1RvQWRkcmVzcyBmYWlsZWQnKQogICAgICAgIGlmIGZhbWlseSA9PSBzb2NrZXQuQUZfSU5FVDoKICAgICAgICAgICAgcmV0dXJuICcnLmpvaW4obWFwKGNociwgbHBBZGRyZXNzWzQ6OF0pKQogICAgICAgIGVsaWYgZmFtaWx5ID09IHNvY2tldC5BRl9JTkVUNjoKICAgICAgICAgICAgcmV0dXJuICcnLmpvaW4obWFwKGNociwgbHBBZGRyZXNzWzg6MjRdKSkKICAgIHJhaXNlIEV4Y2VwdGlvbignbm8gc3VpdGFibGUgaW5ldF9wdG9uIGZ1bmN0aW9uYWxpdHkgaXMgYXZhaWxhYmxlJykKCkBleHBvcnQKZGVmIHBhY2tldF9lbnVtX3RsdnMocGt0LCB0bHZfdHlwZT1Ob25lKToKICAgIG9mZnNldCA9IDAKICAgIHdoaWxlIG9mZnNldCA8IGxlbihwa3QpOgogICAgICAgIHRsdiA9IHN0cnVjdC51bnBhY2soJz5JSScsIHBrdFtvZmZzZXQ6b2Zmc2V0ICsgOF0pCiAgICAgICAgaWYgdGx2X3R5cGUgaXMgTm9uZSBvciAodGx2WzFdICYgflRMVl9NRVRBX1RZUEVfQ09NUFJFU1NFRCkgPT0gdGx2X3R5cGU6CiAgICAgICAgICAgIHZhbCA9IHBrdFtvZmZzZXQgKyA4OihvZmZzZXQgKyA4ICsgKHRsdlswXSAtIDgpKV0KICAgICAgICAgICAgaWYgKHRsdlsxXSAmIFRMVl9NRVRBX1RZUEVfU1RSSU5HKSA9PSBUTFZfTUVUQV9UWVBFX1NUUklORzoKICAgICAgICAgICAgICAgIHZhbCA9IHN0cih2YWwuc3BsaXQoTlVMTF9CWVRFLCAxKVswXSkKICAgICAgICAgICAgZWxpZiAodGx2WzFdICYgVExWX01FVEFfVFlQRV9VSU5UKSA9PSBUTFZfTUVUQV9UWVBFX1VJTlQ6CiAgICAgICAgICAgICAgICB2YWwgPSBzdHJ1Y3QudW5wYWNrKCc+SScsIHZhbClbMF0KICAgICAgICAgICAgZWxpZiAodGx2WzFdICYgVExWX01FVEFfVFlQRV9RV09SRCkgPT0gVExWX01FVEFfVFlQRV9RV09SRDoKICAgICAgICAgICAgICAgIHZhbCA9IHN0cnVjdC51bnBhY2soJz5RJywgdmFsKVswXQogICAgICAgICAgICBlbGlmICh0bHZbMV0gJiBUTFZfTUVUQV9UWVBFX0JPT0wpID09IFRMVl9NRVRBX1RZUEVfQk9PTDoKICAgICAgICAgICAgICAgIHZhbCA9IGJvb2woc3RydWN0LnVucGFjaygnYicsIHZhbClbMF0pCiAgICAgICAgICAgIGVsaWYgKHRsdlsxXSAmIFRMVl9NRVRBX1RZUEVfUkFXKSA9PSBUTFZfTUVUQV9UWVBFX1JBVzoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgeWllbGQgeyd0eXBlJzogdGx2WzFdLCAnbGVuZ3RoJzogdGx2WzBdLCAndmFsdWUnOiB2YWx9CiAgICAgICAgb2Zmc2V0ICs9IHRsdlswXQogICAgcmFpc2UgU3RvcEl0ZXJhdGlvbigpCgpAZXhwb3J0CmRlZiBwYWNrZXRfZ2V0X3Rsdihwa3QsIHRsdl90eXBlKToKICAgIHRyeToKICAgICAgICB0bHYgPSBsaXN0KHBhY2tldF9lbnVtX3RsdnMocGt0LCB0bHZfdHlwZSkpWzBdCiAgICBleGNlcHQgSW5kZXhFcnJvcjoKICAgICAgICByZXR1cm4ge30KICAgIHJldHVybiB0bHYKCkBleHBvcnQKZGVmIHRsdl9wYWNrKCphcmdzKToKICAgIGlmIGxlbihhcmdzKSA9PSAyOgogICAgICAgIHRsdiA9IHsndHlwZSc6YXJnc1swXSwgJ3ZhbHVlJzphcmdzWzFdfQogICAgZWxzZToKICAgICAgICB0bHYgPSBhcmdzWzBdCiAgICBkYXRhID0gJycKICAgIHZhbHVlID0gdGx2Wyd2YWx1ZSddCiAgICBpZiAodGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX1VJTlQpID09IFRMVl9NRVRBX1RZUEVfVUlOVDoKICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBmbG9hdCk6CiAgICAgICAgICAgIHZhbHVlID0gaW50KHJvdW5kKHZhbHVlKSkKICAgICAgICBkYXRhID0gc3RydWN0LnBhY2soJz5JSUknLCAxMiwgdGx2Wyd0eXBlJ10sIHZhbHVlKQogICAgZWxpZiAodGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX1FXT1JEKSA9PSBUTFZfTUVUQV9UWVBFX1FXT1JEOgogICAgICAgIGRhdGEgPSBzdHJ1Y3QucGFjaygnPklJUScsIDE2LCB0bHZbJ3R5cGUnXSwgdmFsdWUpCiAgICBlbGlmICh0bHZbJ3R5cGUnXSAmIFRMVl9NRVRBX1RZUEVfQk9PTCkgPT0gVExWX01FVEFfVFlQRV9CT09MOgogICAgICAgIGRhdGEgPSBzdHJ1Y3QucGFjaygnPklJJywgOSwgdGx2Wyd0eXBlJ10pICsgYnl0ZXMoY2hyKGludChib29sKHZhbHVlKSkpLCAnVVRGLTgnKQogICAgZWxzZToKICAgICAgICBpZiBzeXMudmVyc2lvbl9pbmZvWzBdIDwgMyBhbmQgdmFsdWUuX19jbGFzc19fLl9fbmFtZV9fID09ICd1bmljb2RlJzoKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5lbmNvZGUoJ1VURi04JykKICAgICAgICBlbGlmIG5vdCBpc19ieXRlcyh2YWx1ZSk6CiAgICAgICAgICAgIHZhbHVlID0gYnl0ZXModmFsdWUsICdVVEYtOCcpCiAgICAgICAgaWYgKHRsdlsndHlwZSddICYgVExWX01FVEFfVFlQRV9TVFJJTkcpID09IFRMVl9NRVRBX1RZUEVfU1RSSU5HOgogICAgICAgICAgICBkYXRhID0gc3RydWN0LnBhY2soJz5JSScsIDggKyBsZW4odmFsdWUpICsgMSwgdGx2Wyd0eXBlJ10pICsgdmFsdWUgKyBOVUxMX0JZVEUKICAgICAgICBlbGlmICh0bHZbJ3R5cGUnXSAmIFRMVl9NRVRBX1RZUEVfUkFXKSA9PSBUTFZfTUVUQV9UWVBFX1JBVzoKICAgICAgICAgICAgZGF0YSA9IHN0cnVjdC5wYWNrKCc+SUknLCA4ICsgbGVuKHZhbHVlKSwgdGx2Wyd0eXBlJ10pICsgdmFsdWUKICAgICAgICBlbGlmICh0bHZbJ3R5cGUnXSAmIFRMVl9NRVRBX1RZUEVfR1JPVVApID09IFRMVl9NRVRBX1RZUEVfR1JPVVA6CiAgICAgICAgICAgIGRhdGEgPSBzdHJ1Y3QucGFjaygnPklJJywgOCArIGxlbih2YWx1ZSksIHRsdlsndHlwZSddKSArIHZhbHVlCiAgICAgICAgZWxpZiAodGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX0NPTVBMRVgpID09IFRMVl9NRVRBX1RZUEVfQ09NUExFWDoKICAgICAgICAgICAgZGF0YSA9IHN0cnVjdC5wYWNrKCc+SUknLCA4ICsgbGVuKHZhbHVlKSwgdGx2Wyd0eXBlJ10pICsgdmFsdWUKICAgIHJldHVybiBkYXRhCgpAZXhwb3J0CmRlZiB0bHZfcGFja19yZXF1ZXN0KG1ldGhvZCwgcGFydHM9Tm9uZSk6CiAgICBwa3QgID0gc3RydWN0LnBhY2soJz5JJywgUEFDS0VUX1RZUEVfUkVRVUVTVCkKICAgIHBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9NRVRIT0QsIG1ldGhvZCkKICAgIHBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9VVUlELCBiaW5hc2NpaS5hMmJfaGV4KGJ5dGVzKFBBWUxPQURfVVVJRCwgJ1VURi04JykpKQogICAgcGt0ICs9IHRsdl9wYWNrKFRMVl9UWVBFX1JFUVVFU1RfSUQsIGdlbmVyYXRlX3JlcXVlc3RfaWQoKSkKICAgIHBhcnRzID0gcGFydHMgb3IgW10KICAgIGZvciBwYXJ0IGluIHBhcnRzOgogICAgICAgIHBrdCArPSB0bHZfcGFjayhwYXJ0Wyd0eXBlJ10sIHBhcnRbJ3ZhbHVlJ10pCiAgICByZXR1cm4gcGt0CgojQGV4cG9ydApjbGFzcyBNZXRlcnByZXRlckNoYW5uZWwob2JqZWN0KToKICAgIGRlZiBjb3JlX2Nsb3NlKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBzZWxmLmNsb3NlKCkKICAgICAgICByZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCiAgICBkZWYgY29yZV9lb2Yoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX0JPT0wsIHNlbGYuZW9mKCkpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIGNvcmVfcmVhZChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgbGVuZ3RoID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfTEVOR1RIKVsndmFsdWUnXQogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX0NIQU5ORUxfREFUQSwgc2VsZi5yZWFkKGxlbmd0aCkpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIGNvcmVfd3JpdGUoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIGNoYW5uZWxfZGF0YSA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfREFUQSlbJ3ZhbHVlJ10KICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9MRU5HVEgsIHNlbGYud3JpdGUoY2hhbm5lbF9kYXRhKSkKICAgICAgICByZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgcmFpc2UgTm90SW1wbGVtZW50ZWRFcnJvcigpCgogICAgZGVmIGVvZihzZWxmKToKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgaXNfYWxpdmUoc2VsZik6CiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBkZWYgbm90aWZ5KHNlbGYpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIHJlYWQoc2VsZiwgbGVuZ3RoKToKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yKCkKCiAgICBkZWYgd3JpdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgcmFpc2UgTm90SW1wbGVtZW50ZWRFcnJvcigpCgojQGV4cG9ydApjbGFzcyBNZXRlcnByZXRlckZpbGUoTWV0ZXJwcmV0ZXJDaGFubmVsKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBmaWxlX29iaik6CiAgICAgICAgc2VsZi5maWxlX29iaiA9IGZpbGVfb2JqCiAgICAgICAgc3VwZXIoTWV0ZXJwcmV0ZXJGaWxlLCBzZWxmKS5fX2luaXRfXygpCgogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgIHNlbGYuZmlsZV9vYmouY2xvc2UoKQoKICAgIGRlZiBlb2Yoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuZmlsZV9vYmoudGVsbCgpID49IG9zLmZzdGF0KHNlbGYuZmlsZV9vYmouZmlsZW5vKCkpLnN0X3NpemUKCiAgICBkZWYgcmVhZChzZWxmLCBsZW5ndGgpOgogICAgICAgIHJldHVybiBzZWxmLmZpbGVfb2JqLnJlYWQobGVuZ3RoKQoKICAgIGRlZiB3cml0ZShzZWxmLCBkYXRhKToKICAgICAgICBzZWxmLmZpbGVfb2JqLndyaXRlKGRhdGEpCiAgICAgICAgcmV0dXJuIGxlbihkYXRhKQpleHBvcnQoTWV0ZXJwcmV0ZXJGaWxlKQoKI0BleHBvcnQKY2xhc3MgTWV0ZXJwcmV0ZXJQcm9jZXNzKE1ldGVycHJldGVyQ2hhbm5lbCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcHJvY19oKToKICAgICAgICBzZWxmLnByb2NfaCA9IHByb2NfaAogICAgICAgIHN1cGVyKE1ldGVycHJldGVyUHJvY2Vzcywgc2VsZikuX19pbml0X18oKQoKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICBzZWxmLnByb2NfaC5raWxsKCkKCiAgICBkZWYgaXNfYWxpdmUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYucHJvY19oLnBvbGwoKSBpcyBOb25lCgogICAgZGVmIHJlYWQoc2VsZiwgbGVuZ3RoKToKICAgICAgICBkYXRhID0gJycKICAgICAgICBzdGRvdXRfcmVhZGVyID0gc2VsZi5wcm9jX2guc3Rkb3V0X3JlYWRlcgogICAgICAgIGlmIHN0ZG91dF9yZWFkZXIuaXNfcmVhZF9yZWFkeSgpOgogICAgICAgICAgICBkYXRhID0gc3Rkb3V0X3JlYWRlci5yZWFkKGxlbmd0aCkKICAgICAgICByZXR1cm4gZGF0YQoKICAgIGRlZiB3cml0ZShzZWxmLCBkYXRhKToKICAgICAgICBzZWxmLnByb2NfaC53cml0ZShkYXRhKQogICAgICAgIHJldHVybiBsZW4oZGF0YSkKZXhwb3J0KE1ldGVycHJldGVyUHJvY2VzcykKCiNAZXhwb3J0CmNsYXNzIE1ldGVycHJldGVyU29ja2V0KE1ldGVycHJldGVyQ2hhbm5lbCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgc29jayk6CiAgICAgICAgc2VsZi5zb2NrID0gc29jawogICAgICAgIHNlbGYuX2lzX2FsaXZlID0gVHJ1ZQogICAgICAgIHN1cGVyKE1ldGVycHJldGVyU29ja2V0LCBzZWxmKS5fX2luaXRfXygpCgogICAgZGVmIGNvcmVfd3JpdGUoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc3RhdHVzLCByZXNwb25zZSA9IHN1cGVyKE1ldGVycHJldGVyU29ja2V0LCBzZWxmKS5jb3JlX3dyaXRlKHJlcXVlc3QsIHJlc3BvbnNlKQogICAgICAgIGV4Y2VwdCBzb2NrZXQuZXJyb3I6CiAgICAgICAgICAgIHNlbGYuY2xvc2UoKQogICAgICAgICAgICBzZWxmLl9pc19hbGl2ZSA9IEZhbHNlCiAgICAgICAgICAgIHN0YXR1cyA9IEVSUk9SX0ZBSUxVUkUKICAgICAgICByZXR1cm4gc3RhdHVzLCByZXNwb25zZQoKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5zb2NrLmNsb3NlKCkKCiAgICBkZWYgZmlsZW5vKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnNvY2suZmlsZW5vKCkKCiAgICBkZWYgaXNfYWxpdmUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuX2lzX2FsaXZlCgogICAgZGVmIHJlYWQoc2VsZiwgbGVuZ3RoKToKICAgICAgICByZXR1cm4gc2VsZi5zb2NrLnJlY3YobGVuZ3RoKQoKICAgIGRlZiB3cml0ZShzZWxmLCBkYXRhKToKICAgICAgICByZXR1cm4gc2VsZi5zb2NrLnNlbmQoZGF0YSkKZXhwb3J0KE1ldGVycHJldGVyU29ja2V0KQoKI0BleHBvcnQKY2xhc3MgTWV0ZXJwcmV0ZXJTb2NrZXRUQ1BDbGllbnQoTWV0ZXJwcmV0ZXJTb2NrZXQpOgogICAgcGFzcwpleHBvcnQoTWV0ZXJwcmV0ZXJTb2NrZXRUQ1BDbGllbnQpCgojQGV4cG9ydApjbGFzcyBNZXRlcnByZXRlclNvY2tldFRDUFNlcnZlcihNZXRlcnByZXRlclNvY2tldCk6CiAgICBwYXNzCmV4cG9ydChNZXRlcnByZXRlclNvY2tldFRDUFNlcnZlcikKCiNAZXhwb3J0CmNsYXNzIE1ldGVycHJldGVyU29ja2V0VURQQ2xpZW50KE1ldGVycHJldGVyU29ja2V0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzb2NrLCBwZWVyX2FkZHJlc3M9Tm9uZSk6CiAgICAgICAgc3VwZXIoTWV0ZXJwcmV0ZXJTb2NrZXRVRFBDbGllbnQsIHNlbGYpLl9faW5pdF9fKHNvY2spCiAgICAgICAgc2VsZi5wZWVyX2FkZHJlc3MgPSBwZWVyX2FkZHJlc3MKCiAgICBkZWYgY29yZV93cml0ZShzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgcGVlcl9ob3N0ID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfUEVFUl9IT1NUKS5nZXQoJ3ZhbHVlJykKICAgICAgICBwZWVyX3BvcnQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9QRUVSX1BPUlQpLmdldCgndmFsdWUnKQogICAgICAgIGlmIHBlZXJfaG9zdCBhbmQgcGVlcl9wb3J0OgogICAgICAgICAgICBwZWVyX2FkZHJlc3MgPSAocGVlcl9ob3N0LCBwZWVyX3BvcnQpCiAgICAgICAgZWxpZiBzZWxmLnBlZXJfYWRkcmVzczoKICAgICAgICAgICAgcGVlcl9hZGRyZXNzID0gc2VsZi5wZWVyX2FkZHJlc3MKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBSdW50aW1lRXJyb3IoJ3BlZXJfaG9zdCBhbmQgcGVlcl9wb3J0IG11c3QgYmUgc3BlY2lmaWVkIHdpdGggYW4gdW5ib3VuZC91bmNvbm5lY3RlZCBVRFAgY2hhbm5lbCcpCiAgICAgICAgY2hhbm5lbF9kYXRhID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfQ0hBTk5FTF9EQVRBKVsndmFsdWUnXQogICAgICAgIHRyeToKICAgICAgICAgICAgbGVuZ3RoID0gc2VsZi5zb2NrLnNlbmR0byhjaGFubmVsX2RhdGEsIHBlZXJfYWRkcmVzcykKICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICBzZWxmLmNsb3NlKCkKICAgICAgICAgICAgc2VsZi5faXNfYWxpdmUgPSBGYWxzZQogICAgICAgICAgICBzdGF0dXMgPSBFUlJPUl9GQUlMVVJFCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfTEVOR1RILCBsZW5ndGgpCiAgICAgICAgICAgIHN0YXR1cyA9IEVSUk9SX1NVQ0NFU1MKICAgICAgICByZXR1cm4gc3RhdHVzLCByZXNwb25zZQoKICAgIGRlZiByZWFkKHNlbGYsIGxlbmd0aCk6CiAgICAgICAgcmV0dXJuIHNlbGYuc29jay5yZWN2ZnJvbShsZW5ndGgpWzBdCgogICAgZGVmIHdyaXRlKHNlbGYsIGRhdGEpOgogICAgICAgIHNlbGYuc29jay5zZW5kdG8oZGF0YSwgc2VsZi5wZWVyX2FkZHJlc3MpCmV4cG9ydChNZXRlcnByZXRlclNvY2tldFVEUENsaWVudCkKCmNsYXNzIFNURFByb2Nlc3NCdWZmZXIodGhyZWFkaW5nLlRocmVhZCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgc3RkLCBpc19hbGl2ZSk6CiAgICAgICAgdGhyZWFkaW5nLlRocmVhZC5fX2luaXRfXyhzZWxmKQogICAgICAgIHNlbGYuc3RkID0gc3RkCiAgICAgICAgc2VsZi5pc19hbGl2ZSA9IGlzX2FsaXZlCiAgICAgICAgc2VsZi5kYXRhID0gYnl0ZXMoKQogICAgICAgIHNlbGYuZGF0YV9sb2NrID0gdGhyZWFkaW5nLlJMb2NrKCkKCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgIGZvciBieXRlIGluIGl0ZXIobGFtYmRhOiBzZWxmLnN0ZC5yZWFkKDEpLCBieXRlcygpKToKICAgICAgICAgICAgc2VsZi5kYXRhX2xvY2suYWNxdWlyZSgpCiAgICAgICAgICAgIHNlbGYuZGF0YSArPSBieXRlCiAgICAgICAgICAgIHNlbGYuZGF0YV9sb2NrLnJlbGVhc2UoKQoKICAgIGRlZiBpc19yZWFkX3JlYWR5KHNlbGYpOgogICAgICAgIHJldHVybiBsZW4oc2VsZi5kYXRhKSAhPSAwCgogICAgZGVmIHBlZWsoc2VsZiwgbCA9IE5vbmUpOgogICAgICAgIGRhdGEgPSBieXRlcygpCiAgICAgICAgc2VsZi5kYXRhX2xvY2suYWNxdWlyZSgpCiAgICAgICAgaWYgbCA9PSBOb25lOgogICAgICAgICAgICBkYXRhID0gc2VsZi5kYXRhCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGF0YSA9IHNlbGYuZGF0YVswOmxdCiAgICAgICAgc2VsZi5kYXRhX2xvY2sucmVsZWFzZSgpCiAgICAgICAgcmV0dXJuIGRhdGEKCiAgICBkZWYgcmVhZChzZWxmLCBsID0gTm9uZSk6CiAgICAgICAgc2VsZi5kYXRhX2xvY2suYWNxdWlyZSgpCiAgICAgICAgZGF0YSA9IHNlbGYucGVlayhsKQogICAgICAgIHNlbGYuZGF0YSA9IHNlbGYuZGF0YVtsZW4oZGF0YSk6XQogICAgICAgIHNlbGYuZGF0YV9sb2NrLnJlbGVhc2UoKQogICAgICAgIHJldHVybiBkYXRhCgojQGV4cG9ydApjbGFzcyBTVERQcm9jZXNzKHN1YnByb2Nlc3MuUG9wZW4pOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgZGVidWdfcHJpbnQoJ1sqXSBzdGFydGluZyBwcm9jZXNzOiAnICsgcmVwcihhcmdzWzBdKSkKICAgICAgICBzdWJwcm9jZXNzLlBvcGVuLl9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncykKICAgICAgICBzZWxmLmVjaG9fcHJvdGVjdGlvbiA9IEZhbHNlCgogICAgZGVmIGlzX2FsaXZlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnBvbGwoKSBpcyBOb25lCgogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgIHNlbGYuc3Rkb3V0X3JlYWRlciA9IFNURFByb2Nlc3NCdWZmZXIoc2VsZi5zdGRvdXQsIHNlbGYuaXNfYWxpdmUpCiAgICAgICAgc2VsZi5zdGRvdXRfcmVhZGVyLnN0YXJ0KCkKICAgICAgICBzZWxmLnN0ZGVycl9yZWFkZXIgPSBTVERQcm9jZXNzQnVmZmVyKHNlbGYuc3RkZXJyLCBzZWxmLmlzX2FsaXZlKQogICAgICAgIHNlbGYuc3RkZXJyX3JlYWRlci5zdGFydCgpCgogICAgZGVmIHdyaXRlKHNlbGYsIGNoYW5uZWxfZGF0YSk6CiAgICAgICAgbGVuZ3RoID0gc2VsZi5zdGRpbi53cml0ZShjaGFubmVsX2RhdGEpCiAgICAgICAgc2VsZi5zdGRpbi5mbHVzaCgpCiAgICAgICAgaWYgc2VsZi5lY2hvX3Byb3RlY3Rpb246CiAgICAgICAgICAgIGVuZF90aW1lID0gdGltZS50aW1lKCkgKyAwLjUKICAgICAgICAgICAgb3V0X2RhdGEgPSBieXRlcygpCiAgICAgICAgICAgIHdoaWxlICh0aW1lLnRpbWUoKSA8IGVuZF90aW1lKSBhbmQgKG91dF9kYXRhICE9IGNoYW5uZWxfZGF0YSk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLnN0ZG91dF9yZWFkZXIuaXNfcmVhZF9yZWFkeSgpOgogICAgICAgICAgICAgICAgICAgIG91dF9kYXRhID0gc2VsZi5zdGRvdXRfcmVhZGVyLnBlZWsobGVuKGNoYW5uZWxfZGF0YSkpCiAgICAgICAgICAgIGlmIG91dF9kYXRhID09IGNoYW5uZWxfZGF0YToKICAgICAgICAgICAgICAgIHNlbGYuc3Rkb3V0X3JlYWRlci5yZWFkKGxlbihjaGFubmVsX2RhdGEpKQogICAgICAgIHJldHVybiBsZW5ndGgKZXhwb3J0KFNURFByb2Nlc3MpCgpjbGFzcyBUcmFuc3BvcnQob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmNvbW11bmljYXRpb25fdGltZW91dCA9IFNFU1NJT05fQ09NTVVOSUNBVElPTl9USU1FT1VUCiAgICAgICAgc2VsZi5jb21tdW5pY2F0aW9uX2xhc3QgPSAwCiAgICAgICAgc2VsZi5yZXRyeV90b3RhbCA9IFNFU1NJT05fUkVUUllfVE9UQUwKICAgICAgICBzZWxmLnJldHJ5X3dhaXQgPSBTRVNTSU9OX1JFVFJZX1dBSVQKICAgICAgICBzZWxmLnJlcXVlc3RfcmV0aXJlID0gRmFsc2UKCiAgICBkZWYgX19yZXByX18oc2VsZik6CiAgICAgICAgcmV0dXJuICI8ezB9IHVybD0nezF9JyA+Ii5mb3JtYXQoc2VsZi5fX2NsYXNzX18uX19uYW1lX18sIHNlbGYudXJsKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGNvbW11bmljYXRpb25faGFzX2V4cGlyZWQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuY29tbXVuaWNhdGlvbl9sYXN0ICsgc2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQgPCB0aW1lLnRpbWUoKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHNob3VsZF9yZXRpcmUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuY29tbXVuaWNhdGlvbl9oYXNfZXhwaXJlZCBvciBzZWxmLnJlcXVlc3RfcmV0aXJlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGZyb21fcmVxdWVzdChyZXF1ZXN0KToKICAgICAgICB1cmwgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19VUkwpWyd2YWx1ZSddCiAgICAgICAgaWYgdXJsLnN0YXJ0c3dpdGgoJ3RjcCcpOgogICAgICAgICAgICB0cmFuc3BvcnQgPSBUY3BUcmFuc3BvcnQodXJsKQogICAgICAgIGVsaWYgdXJsLnN0YXJ0c3dpdGgoJ2h0dHAnKToKICAgICAgICAgICAgcHJveHkgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19QUk9YWV9IT1NUKS5nZXQoJ3ZhbHVlJykKICAgICAgICAgICAgdXNlcl9hZ2VudCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX1VBKS5nZXQoJ3ZhbHVlJywgSFRUUF9VU0VSX0FHRU5UKQogICAgICAgICAgICBodHRwX2hlYWRlcnMgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19IRUFERVJTKS5nZXQoJ3ZhbHVlJywgTm9uZSkKICAgICAgICAgICAgdHJhbnNwb3J0ID0gSHR0cFRyYW5zcG9ydCh1cmwsIHByb3h5PXByb3h5LCB1c2VyX2FnZW50PXVzZXJfYWdlbnQpCiAgICAgICAgICAgIGlmIGh0dHBfaGVhZGVyczoKICAgICAgICAgICAgICAgIGhlYWRlcnMgPSB7fQogICAgICAgICAgICAgICAgZm9yIGggaW4gaHR0cF9oZWFkZXJzLnN0cmlwKCkuc3BsaXQoIlxyXG4iKToKICAgICAgICAgICAgICAgICAgICBwID0gaC5zcGxpdCgnOicpCiAgICAgICAgICAgICAgICAgICAgaGVhZGVyc1twWzBdLnVwcGVyKCldID0gJycuam9pbihwWzE6MF0pCiAgICAgICAgICAgICAgICBodHRwX2hvc3QgPSBoZWFkZXJzLmdldCgnSE9TVCcpCiAgICAgICAgICAgICAgICBodHRwX2Nvb2tpZSA9IGhlYWRlcnMuZ2V0KCdDT09LSUUnKQogICAgICAgICAgICAgICAgaHR0cF9yZWZlcmVyID0gaGVhZGVycy5nZXQoJ1JFRkVSRVInKQogICAgICAgICAgICAgICAgdHJhbnNwb3J0ID0gSHR0cFRyYW5zcG9ydCh1cmwsIHByb3h5PXByb3h5LCB1c2VyX2FnZW50PXVzZXJfYWdlbnQsIGh0dHBfaG9zdD1odHRwX2hvc3QsCiAgICAgICAgICAgICAgICAgICAgICAgIGh0dHBfY29va2llPWh0dHBfY29va2llLCBodHRwX3JlZmVyZXI9aHR0cF9yZWZlcmVyKQogICAgICAgIHRyYW5zcG9ydC5jb21tdW5pY2F0aW9uX3RpbWVvdXQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19DT01NX1RJTUVPVVQpLmdldCgndmFsdWUnLCBTRVNTSU9OX0NPTU1VTklDQVRJT05fVElNRU9VVCkKICAgICAgICB0cmFuc3BvcnQucmV0cnlfdG90YWwgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19SRVRSWV9UT1RBTCkuZ2V0KCd2YWx1ZScsIFNFU1NJT05fUkVUUllfVE9UQUwpCiAgICAgICAgdHJhbnNwb3J0LnJldHJ5X3dhaXQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19SRVRSWV9XQUlUKS5nZXQoJ3ZhbHVlJywgU0VTU0lPTl9SRVRSWV9XQUlUKQogICAgICAgIHJldHVybiB0cmFuc3BvcnQKCiAgICBkZWYgX2FjdGl2YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGFjdGl2YXRlKHNlbGYpOgogICAgICAgIGVuZF90aW1lID0gdGltZS50aW1lKCkgKyBzZWxmLnJldHJ5X3RvdGFsCiAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgPCBlbmRfdGltZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYWN0aXZhdGVfc3VjY2VlZGVkID0gc2VsZi5fYWN0aXZhdGUoKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBhY3RpdmF0ZV9zdWNjZWVkZWQgPSBGYWxzZQogICAgICAgICAgICBpZiBhY3RpdmF0ZV9zdWNjZWVkZWQ6CiAgICAgICAgICAgICAgICBzZWxmLmNvbW11bmljYXRpb25fbGFzdCA9IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICB0aW1lLnNsZWVwKHNlbGYucmV0cnlfd2FpdCkKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2RlYWN0aXZhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuCgogICAgZGVmIGRlYWN0aXZhdGUoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9kZWFjdGl2YXRlKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBzZWxmLmNvbW11bmljYXRpb25fbGFzdCA9IDAKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZWNyeXB0X3BhY2tldChzZWxmLCBwa3QpOgogICAgICAgIGlmIHBrdCBhbmQgbGVuKHBrdCkgPiBQQUNLRVRfSEVBREVSX1NJWkU6CiAgICAgICAgICAgICMgV2UgZG9uJ3Qgc3VwcG9ydCBBRVMgZW5jcnlwdGlvbiB5ZXQsIHNvIGp1c3QgZG8gdGhlIG5vcm1hbAogICAgICAgICAgICAjIFhPUiB0aGluZyBhbmQgbW92ZSBvbgogICAgICAgICAgICB4b3Jfa2V5ID0gc3RydWN0LnVucGFjaygnQkJCQicsIHBrdFs6UEFDS0VUX1hPUl9LRVlfU0laRV0pCiAgICAgICAgICAgIHJhdyA9IHhvcl9ieXRlcyh4b3Jfa2V5LCBwa3QpCiAgICAgICAgICAgIHJldHVybiByYXdbUEFDS0VUX0hFQURFUl9TSVpFOl0KICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRfcGFja2V0KHNlbGYpOgogICAgICAgIHNlbGYucmVxdWVzdF9yZXRpcmUgPSBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgcGt0ID0gc2VsZi5kZWNyeXB0X3BhY2tldChzZWxmLl9nZXRfcGFja2V0KCkpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBkZWJ1Z190cmFjZWJhY2soKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIHBrdCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHNlbGYuY29tbXVuaWNhdGlvbl9sYXN0ID0gdGltZS50aW1lKCkKICAgICAgICByZXR1cm4gcGt0CgogICAgZGVmIGVuY3J5cHRfcGFja2V0KHNlbGYsIHBrdCk6CiAgICAgICAgIyBUaGUgcGFja2V0IG5vdyBoYXMgdG8gY29udGFpbiBzZXNzaW9uIEdVSUQgYW5kIGVuY3J5cHRpb24gZmxhZyBpbmZvCiAgICAgICAgIyBBbmQgZ2l2ZW4gdGhhdCB3ZSdyZSBub3QgeWV0IHN1cHBvcnRpbmcgQUVTLCB3ZSdyZSBnb2luZyB0byBqdXN0CiAgICAgICAgIyBhbHdheXMgcmV0dXJuIHRoZSBzZXNzaW9uIGd1aWQgYW5kIHRoZSBlbmNyeXB0aW9uIGZsYWcgc2V0IHRvIDAKICAgICAgICAjIFRPRE86IHdlJ2xsIGFkZCBlbmNyeXB0aW9uIHNvb24hCiAgICAgICAgeG9yX2tleSA9IHJhbmRfeG9yX2tleSgpCiAgICAgICAgcmF3ID0gYmluYXNjaWkuYTJiX2hleChieXRlcyhTRVNTSU9OX0dVSUQsICdVVEYtOCcpKSArIHN0cnVjdC5wYWNrKCc+SScsIEVOQ19OT05FKSArIHBrdAogICAgICAgIHJlc3VsdCA9IHN0cnVjdC5wYWNrKCdCQkJCJywgKnhvcl9rZXkpICsgeG9yX2J5dGVzKHhvcl9rZXksIHJhdykKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgZGVmIHNlbmRfcGFja2V0KHNlbGYsIHBrdCk6CiAgICAgICAgcGt0ID0gc3RydWN0LnBhY2soJz5JJywgbGVuKHBrdCkgKyA0KSArIHBrdAogICAgICAgIHNlbGYucmVxdWVzdF9yZXRpcmUgPSBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fc2VuZF9wYWNrZXQoc2VsZi5lbmNyeXB0X3BhY2tldChwa3QpKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgZGVidWdfdHJhY2ViYWNrKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgc2VsZi5jb21tdW5pY2F0aW9uX2xhc3QgPSB0aW1lLnRpbWUoKQogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIHRsdl9wYWNrX3RpbWVvdXRzKHNlbGYpOgogICAgICAgIHJlc3BvbnNlICA9IHRsdl9wYWNrKFRMVl9UWVBFX1RSQU5TX0NPTU1fVElNRU9VVCwgc2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQpCiAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfUkVUUllfVE9UQUwsIHNlbGYucmV0cnlfdG90YWwpCiAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfUkVUUllfV0FJVCwgc2VsZi5yZXRyeV93YWl0KQogICAgICAgIHJldHVybiByZXNwb25zZQoKICAgIGRlZiB0bHZfcGFja190cmFuc3BvcnRfZ3JvdXAoc2VsZik6CiAgICAgICAgdHJhbnNfZ3JvdXAgID0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfVVJMLCBzZWxmLnVybCkKICAgICAgICB0cmFuc19ncm91cCArPSBzZWxmLnRsdl9wYWNrX3RpbWVvdXRzKCkKICAgICAgICByZXR1cm4gdHJhbnNfZ3JvdXAKCmNsYXNzIEh0dHBUcmFuc3BvcnQoVHJhbnNwb3J0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB1cmwsIHByb3h5PU5vbmUsIHVzZXJfYWdlbnQ9Tm9uZSwgaHR0cF9ob3N0PU5vbmUsIGh0dHBfcmVmZXJlcj1Ob25lLCBodHRwX2Nvb2tpZT1Ob25lKToKICAgICAgICBzdXBlcihIdHRwVHJhbnNwb3J0LCBzZWxmKS5fX2luaXRfXygpCiAgICAgICAgb3BlbmVyX2FyZ3MgPSBbXQogICAgICAgIHNjaGVtZSA9IHVybC5zcGxpdCgnOicsIDEpWzBdCiAgICAgICAgaWYgc2NoZW1lID09ICdodHRwcycgYW5kICgoc3lzLnZlcnNpb25faW5mb1swXSA9PSAyIGFuZCBzeXMudmVyc2lvbl9pbmZvID49ICgyLCA3LCA5KSkgb3Igc3lzLnZlcnNpb25faW5mbyA+PSAoMywgNCwgMykpOgogICAgICAgICAgICBpbXBvcnQgc3NsCiAgICAgICAgICAgIHNzbF9jdHggPSBzc2wuU1NMQ29udGV4dChzc2wuUFJPVE9DT0xfU1NMdjIzKQogICAgICAgICAgICBzc2xfY3R4LmNoZWNrX2hvc3RuYW1lID0gRmFsc2UKICAgICAgICAgICAgc3NsX2N0eC52ZXJpZnlfbW9kZSA9IHNzbC5DRVJUX05PTkUKICAgICAgICAgICAgb3BlbmVyX2FyZ3MuYXBwZW5kKHVybGxpYi5IVFRQU0hhbmRsZXIoMCwgc3NsX2N0eCkpCiAgICAgICAgaWYgcHJveHk6CiAgICAgICAgICAgIG9wZW5lcl9hcmdzLmFwcGVuZCh1cmxsaWIuUHJveHlIYW5kbGVyKHtzY2hlbWU6IHByb3h5fSkpCiAgICAgICAgc2VsZi5wcm94eSA9IHByb3h5CiAgICAgICAgb3BlbmVyID0gdXJsbGliLmJ1aWxkX29wZW5lcigqb3BlbmVyX2FyZ3MpCiAgICAgICAgb3BlbmVyLmFkZGhlYWRlcnMgPSBbXQogICAgICAgIGlmIHVzZXJfYWdlbnQ6CiAgICAgICAgICAgIG9wZW5lci5hZGRoZWFkZXJzLmFwcGVuZCgoJ1VzZXItQWdlbnQnLCB1c2VyX2FnZW50KSkKICAgICAgICBpZiBodHRwX2Nvb2tpZToKICAgICAgICAgICAgb3BlbmVyLmFkZGhlYWRlcnMuYXBwZW5kKCgnQ29va2llJywgaHR0cF9jb29raWUpKQogICAgICAgIGlmIGh0dHBfcmVmZXJlcjoKICAgICAgICAgICAgb3BlbmVyLmFkZGhlYWRlcnMuYXBwZW5kKCgnUmVmZXJlcicsIGh0dHBfcmVmZXJlcikpCiAgICAgICAgc2VsZi51c2VyX2FnZW50ID0gdXNlcl9hZ2VudAogICAgICAgIHVybGxpYi5pbnN0YWxsX29wZW5lcihvcGVuZXIpCiAgICAgICAgc2VsZi51cmwgPSB1cmwKICAgICAgICBzZWxmLl9odHRwX3JlcXVlc3RfaGVhZGVycyA9IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSd9CiAgICAgICAgaWYgaHR0cF9ob3N0OgogICAgICAgICAgICBzZWxmLl9odHRwX3JlcXVlc3RfaGVhZGVyc1snSG9zdCddID0gaHR0cF9ob3N0CiAgICAgICAgc2VsZi5fZmlyc3RfcGFja2V0ID0gTm9uZQogICAgICAgIHNlbGYuX2VtcHR5X2NudCA9IDAKCiAgICBkZWYgX2FjdGl2YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgc2VsZi5fZmlyc3RfcGFja2V0ID0gTm9uZQogICAgICAgIHBhY2tldCA9IHNlbGYuX2dldF9wYWNrZXQoKQogICAgICAgIGlmIHBhY2tldCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBzZWxmLl9maXJzdF9wYWNrZXQgPSBwYWNrZXQKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBfZ2V0X3BhY2tldChzZWxmKToKICAgICAgICBpZiBzZWxmLl9maXJzdF9wYWNrZXQ6CiAgICAgICAgICAgIHBhY2tldCA9IHNlbGYuX2ZpcnN0X3BhY2tldAogICAgICAgICAgICBzZWxmLl9maXJzdF9wYWNrZXQgPSBOb25lCiAgICAgICAgICAgIHJldHVybiBwYWNrZXQKICAgICAgICBwYWNrZXQgPSBOb25lCiAgICAgICAgeG9yX2tleSA9IE5vbmUKICAgICAgICByZXF1ZXN0ID0gdXJsbGliLlJlcXVlc3Qoc2VsZi51cmwsIE5vbmUsIHNlbGYuX2h0dHBfcmVxdWVzdF9oZWFkZXJzKQogICAgICAgIHRyeToKICAgICAgICAgICAgdXJsX2ggPSB1cmxsaWIudXJsb3BlbihyZXF1ZXN0LCB0aW1lb3V0PXNlbGYuY29tbXVuaWNhdGlvbl90aW1lb3V0KQogICAgICAgICAgICBwYWNrZXQgPSB1cmxfaC5yZWFkKCkKICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2UoMSk6CiAgICAgICAgICAgICAgICBpZiBwYWNrZXQgPT0gJyc6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGlmIGxlbihwYWNrZXQpIDwgUEFDS0VUX0hFQURFUl9TSVpFOgogICAgICAgICAgICAgICAgICAgIHBhY2tldCA9IE5vbmUgICMgbG9va3MgY29ycnVwdAogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB4b3Jfa2V5ID0gc3RydWN0LnVucGFjaygnQkJCQicsIHBhY2tldFs6UEFDS0VUX1hPUl9LRVlfU0laRV0pCiAgICAgICAgICAgICAgICBoZWFkZXIgPSB4b3JfYnl0ZXMoeG9yX2tleSwgcGFja2V0WzpQQUNLRVRfSEVBREVSX1NJWkVdKQogICAgICAgICAgICAgICAgcGt0X2xlbmd0aCA9IHN0cnVjdC51bnBhY2soJz5JJywgaGVhZGVyW1BBQ0tFVF9MRU5HVEhfT0ZGOlBBQ0tFVF9MRU5HVEhfT0ZGK1BBQ0tFVF9MRU5HVEhfU0laRV0pWzBdIC0gOAogICAgICAgICAgICAgICAgaWYgbGVuKHBhY2tldCkgIT0gKHBrdF9sZW5ndGggKyBQQUNLRVRfSEVBREVSX1NJWkUpOgogICAgICAgICAgICAgICAgICAgIHBhY2tldCA9IE5vbmUgICMgbG9va3MgY29ycnVwdAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgZGVidWdfdHJhY2ViYWNrKCdGYWlsdXJlIHRvIHJlY2VpdmUgcGFja2V0IGZyb20gJyArIHNlbGYudXJsKQoKICAgICAgICBpZiBub3QgcGFja2V0OgogICAgICAgICAgICBkZWxheSA9IDEwICogc2VsZi5fZW1wdHlfY250CiAgICAgICAgICAgIGlmIHNlbGYuX2VtcHR5X2NudCA+PSAwOgogICAgICAgICAgICAgICAgZGVsYXkgKj0gMTAKICAgICAgICAgICAgc2VsZi5fZW1wdHlfY250ICs9IDEKICAgICAgICAgICAgdGltZS5zbGVlcChmbG9hdChtaW4oMTAwMDAsIGRlbGF5KSkgLyAxMDAwKQogICAgICAgICAgICByZXR1cm4gcGFja2V0CgogICAgICAgIHNlbGYuX2VtcHR5X2NudCA9IDAKICAgICAgICByZXR1cm4gcGFja2V0CgogICAgZGVmIF9zZW5kX3BhY2tldChzZWxmLCBwYWNrZXQpOgogICAgICAgIHJlcXVlc3QgPSB1cmxsaWIuUmVxdWVzdChzZWxmLnVybCwgcGFja2V0LCBzZWxmLl9odHRwX3JlcXVlc3RfaGVhZGVycykKICAgICAgICB1cmxfaCA9IHVybGxpYi51cmxvcGVuKHJlcXVlc3QsIHRpbWVvdXQ9c2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQpCiAgICAgICAgcmVzcG9uc2UgPSB1cmxfaC5yZWFkKCkKCiAgICBkZWYgcGF0Y2hfdXJpX3BhdGgoc2VsZiwgbmV3X3BhdGgpOgogICAgICAgIG1hdGNoID0gcmUubWF0Y2gocidodHRwcz86Ly9bXi9dKygvLiokKScsIHNlbGYudXJsKQogICAgICAgIGlmIG1hdGNoIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHNlbGYudXJsID0gc2VsZi51cmxbOm1hdGNoLnNwYW4oMSlbMF1dICsgbmV3X3BhdGgKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiB0bHZfcGFja190cmFuc3BvcnRfZ3JvdXAoc2VsZik6CiAgICAgICAgdHJhbnNfZ3JvdXAgID0gc3VwZXIoSHR0cFRyYW5zcG9ydCwgc2VsZikudGx2X3BhY2tfdHJhbnNwb3J0X2dyb3VwKCkKICAgICAgICBpZiBzZWxmLnVzZXJfYWdlbnQ6CiAgICAgICAgICAgIHRyYW5zX2dyb3VwICs9IHRsdl9wYWNrKFRMVl9UWVBFX1RSQU5TX1VBLCBzZWxmLnVzZXJfYWdlbnQpCiAgICAgICAgaWYgc2VsZi5wcm94eToKICAgICAgICAgICAgdHJhbnNfZ3JvdXAgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfUFJPWFlfSE9TVCwgc2VsZi5wcm94eSkKICAgICAgICByZXR1cm4gdHJhbnNfZ3JvdXAKCmNsYXNzIFRjcFRyYW5zcG9ydChUcmFuc3BvcnQpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHVybCwgc29ja2V0PU5vbmUpOgogICAgICAgIHN1cGVyKFRjcFRyYW5zcG9ydCwgc2VsZikuX19pbml0X18oKQogICAgICAgIHNlbGYudXJsID0gdXJsCiAgICAgICAgc2VsZi5zb2NrZXQgPSBzb2NrZXQKICAgICAgICBzZWxmLl9jbGVhbnVwX3RocmVhZCA9IE5vbmUKICAgICAgICBzZWxmLl9maXJzdF9wYWNrZXQgPSBUcnVlCgogICAgZGVmIF9zb2NrX2NsZWFudXAoc2VsZiwgc29jayk6CiAgICAgICAgcmVtYWluaW5nX3RpbWUgPSBzZWxmLmNvbW11bmljYXRpb25fdGltZW91dAogICAgICAgIHdoaWxlIHJlbWFpbmluZ190aW1lID4gMDoKICAgICAgICAgICAgaXRlcl9zdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgaWYgc2VsZWN0LnNlbGVjdChbc29ja10sIFtdLCBbXSwgcmVtYWluaW5nX3RpbWUpWzBdOgogICAgICAgICAgICAgICAgaWYgbGVuKHNvY2sucmVjdig0MDk2KSkgPT0gMDoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICByZW1haW5pbmdfdGltZSAtPSB0aW1lLnRpbWUoKSAtIGl0ZXJfc3RhcnRfdGltZQogICAgICAgIHNvY2suY2xvc2UoKQoKICAgIGRlZiBfYWN0aXZhdGUoc2VsZik6CiAgICAgICAgYWRkcmVzcywgcG9ydCA9IHNlbGYudXJsWzY6XS5yc3BsaXQoJzonLCAxKQogICAgICAgIHBvcnQgPSBpbnQocG9ydC5yc3RyaXAoJy8nKSkKICAgICAgICB0aW1lb3V0ID0gbWF4KHNlbGYuY29tbXVuaWNhdGlvbl90aW1lb3V0LCAzMCkKICAgICAgICBpZiBhZGRyZXNzIGluICgnJywgJzAuMC4wLjAnLCAnOjonKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VydmVyX3NvY2sgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVUNiwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgICAgICAgICAgc2VydmVyX3NvY2suc2V0c29ja29wdChzb2NrZXQuSVBQUk9UT19JUFY2LCBzb2NrZXQuSVBWNl9WNk9OTFksIDApCiAgICAgICAgICAgIGV4Y2VwdCAoQXR0cmlidXRlRXJyb3IsIHNvY2tldC5lcnJvcik6CiAgICAgICAgICAgICAgICBzZXJ2ZXJfc29jayA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQsIHNvY2tldC5TT0NLX1NUUkVBTSkKICAgICAgICAgICAgc2VydmVyX3NvY2suYmluZCgoJycsIHBvcnQpKQogICAgICAgICAgICBzZXJ2ZXJfc29jay5saXN0ZW4oMSkKICAgICAgICAgICAgaWYgbm90IHNlbGVjdC5zZWxlY3QoW3NlcnZlcl9zb2NrXSwgW10sIFtdLCB0aW1lb3V0KVswXToKICAgICAgICAgICAgICAgIHNlcnZlcl9zb2NrLmNsb3NlKCkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBzb2NrLCBfID0gc2VydmVyX3NvY2suYWNjZXB0KCkKICAgICAgICAgICAgc2VydmVyX3NvY2suY2xvc2UoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmICc6JyBpbiBhZGRyZXNzOgogICAgICAgICAgICAgICAgc29jayA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQ2LCBzb2NrZXQuU09DS19TVFJFQU0pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzb2NrID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgICAgICBzb2NrLnNldHRpbWVvdXQodGltZW91dCkKICAgICAgICAgICAgc29jay5jb25uZWN0KChhZGRyZXNzLCBwb3J0KSkKICAgICAgICAgICAgc29jay5zZXR0aW1lb3V0KE5vbmUpCiAgICAgICAgc2VsZi5zb2NrZXQgPSBzb2NrCiAgICAgICAgc2VsZi5fZmlyc3RfcGFja2V0ID0gVHJ1ZQogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIF9kZWFjdGl2YXRlKHNlbGYpOgogICAgICAgIGNsZWFudXAgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLl9zb2NrX2NsZWFudXAsIGFyZ3M9KHNlbGYuc29ja2V0LCkpCiAgICAgICAgY2xlYW51cC5ydW4oKQogICAgICAgIHNlbGYuc29ja2V0ID0gTm9uZQoKICAgIGRlZiBfZ2V0X3BhY2tldChzZWxmKToKICAgICAgICBmaXJzdCA9IHNlbGYuX2ZpcnN0X3BhY2tldAogICAgICAgIHNlbGYuX2ZpcnN0X3BhY2tldCA9IEZhbHNlCiAgICAgICAgaWYgbm90IHNlbGVjdC5zZWxlY3QoW3NlbGYuc29ja2V0XSwgW10sIFtdLCAwLjUpWzBdOgogICAgICAgICAgICByZXR1cm4gYnl0ZXMoKQogICAgICAgIHBhY2tldCA9IHNlbGYuc29ja2V0LnJlY3YoUEFDS0VUX0hFQURFUl9TSVpFKQogICAgICAgIGlmIHBhY2tldCA9PSAnJzogICMgcmVtb3RlIGlzIGNsb3NlZAogICAgICAgICAgICBzZWxmLnJlcXVlc3RfcmV0aXJlID0gVHJ1ZQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIGxlbihwYWNrZXQpICE9IFBBQ0tFVF9IRUFERVJfU0laRToKICAgICAgICAgICAgaWYgZmlyc3QgYW5kIGxlbihwYWNrZXQpID09IDQ6CiAgICAgICAgICAgICAgICByZWNlaXZlZCA9IDAKICAgICAgICAgICAgICAgIGhlYWRlciA9IHBhY2tldFs6NF0KICAgICAgICAgICAgICAgIHBrdF9sZW5ndGggPSBzdHJ1Y3QudW5wYWNrKCc+SScsIGhlYWRlcilbMF0KICAgICAgICAgICAgICAgIHNlbGYuc29ja2V0LnNldHRpbWVvdXQobWF4KHNlbGYuY29tbXVuaWNhdGlvbl90aW1lb3V0LCAzMCkpCiAgICAgICAgICAgICAgICB3aGlsZSByZWNlaXZlZCA8IHBrdF9sZW5ndGg6CiAgICAgICAgICAgICAgICAgICAgcmVjZWl2ZWQgKz0gbGVuKHNlbGYuc29ja2V0LnJlY3YocGt0X2xlbmd0aCAtIHJlY2VpdmVkKSkKICAgICAgICAgICAgICAgIHNlbGYuc29ja2V0LnNldHRpbWVvdXQoTm9uZSkKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9nZXRfcGFja2V0KCkKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgeG9yX2tleSA9IHN0cnVjdC51bnBhY2soJ0JCQkInLCBwYWNrZXRbOlBBQ0tFVF9YT1JfS0VZX1NJWkVdKQogICAgICAgICMgWE9SIHRoZSB3aG9sZSBoZWFkZXIgZmlyc3QKICAgICAgICBoZWFkZXIgPSB4b3JfYnl0ZXMoeG9yX2tleSwgcGFja2V0WzpQQUNLRVRfSEVBREVSX1NJWkVdKQogICAgICAgICMgRXh0cmFjdCBqdXN0IHRoZSBsZW5ndGgKICAgICAgICBwa3RfbGVuZ3RoID0gc3RydWN0LnVucGFjaygnPkknLCBoZWFkZXJbUEFDS0VUX0xFTkdUSF9PRkY6UEFDS0VUX0xFTkdUSF9PRkYrUEFDS0VUX0xFTkdUSF9TSVpFXSlbMF0KICAgICAgICBwa3RfbGVuZ3RoIC09IDgKICAgICAgICAjIFJlYWQgdGhlIHJlc3Qgb2YgdGhlIHBhY2tldAogICAgICAgIHJlc3QgPSBieXRlcygpCiAgICAgICAgd2hpbGUgbGVuKHJlc3QpIDwgcGt0X2xlbmd0aDoKICAgICAgICAgICAgcmVzdCArPSBzZWxmLnNvY2tldC5yZWN2KHBrdF9sZW5ndGggLSBsZW4ocmVzdCkpCiAgICAgICAgIyByZXR1cm4gdGhlIHdob2xlIHBhY2tldCwgYXMgaXQncyBkZWNvZGVkIHNlcGFyYXRlbHkKICAgICAgICByZXR1cm4gcGFja2V0ICsgcmVzdAoKICAgIGRlZiBfc2VuZF9wYWNrZXQoc2VsZiwgcGFja2V0KToKICAgICAgICBzZWxmLnNvY2tldC5zZW5kKHBhY2tldCkKCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBmcm9tX3NvY2tldChjbHMsIHNvY2spOgogICAgICAgIHVybCA9ICd0Y3A6Ly8nCiAgICAgICAgYWRkcmVzcywgcG9ydCA9IHNvY2suZ2V0c29ja25hbWUoKVs6Ml0KICAgICAgICAjIHRoaXMgd2lsbCBuZWVkIHRvIGJlIGNoYW5nZWQgaWYgdGhlIGJpbmQgc3RhZ2VyIGV2ZXIgc3VwcG9ydHMgYmluZGluZyB0byBhIHNwZWNpZmljIGFkZHJlc3MKICAgICAgICBpZiBub3QgYWRkcmVzcyBpbiAoJycsICcwLjAuMC4wJywgJzo6Jyk6CiAgICAgICAgICAgIGFkZHJlc3MsIHBvcnQgPSBzb2NrLmdldHBlZXJuYW1lKClbOjJdCiAgICAgICAgdXJsICs9IGFkZHJlc3MgKyAnOicgKyBzdHIocG9ydCkKICAgICAgICByZXR1cm4gY2xzKHVybCwgc29jaykKCmNsYXNzIFB5dGhvbk1ldGVycHJldGVyKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgdHJhbnNwb3J0KToKICAgICAgICBzZWxmLnRyYW5zcG9ydCA9IHRyYW5zcG9ydAogICAgICAgIHNlbGYuX3RyYW5zcG9ydF9zbGVlcCA9IE5vbmUKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbiA9IE5vbmUKICAgICAgICBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnMgPSB7fQogICAgICAgIHNlbGYuY2hhbm5lbHMgPSB7fQogICAgICAgIHNlbGYubmV4dF9jaGFubmVsX2lkID0gMQogICAgICAgIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHMgPSBbXQogICAgICAgIHNlbGYucHJvY2Vzc2VzID0ge30KICAgICAgICBzZWxmLm5leHRfcHJvY2Vzc19pZCA9IDEKICAgICAgICBzZWxmLnRyYW5zcG9ydHMgPSBbc2VsZi50cmFuc3BvcnRdCiAgICAgICAgc2VsZi5zZXNzaW9uX2V4cGlyeV90aW1lID0gU0VTU0lPTl9FWFBJUkFUSU9OX1RJTUVPVVQKICAgICAgICBzZWxmLnNlc3Npb25fZXhwaXJ5X2VuZCA9IHRpbWUudGltZSgpICsgc2VsZi5zZXNzaW9uX2V4cGlyeV90aW1lCiAgICAgICAgZm9yIGZ1bmMgaW4gbGlzdChmaWx0ZXIobGFtYmRhIHg6IHguc3RhcnRzd2l0aCgnX2NvcmUnKSwgZGlyKHNlbGYpKSk6CiAgICAgICAgICAgIHNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9uc1tmdW5jWzE6XV0gPSBnZXRhdHRyKHNlbGYsIGZ1bmMpCiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQoKICAgIGRlZiByZWdpc3Rlcl9leHRlbnNpb24oc2VsZiwgZXh0ZW5zaW9uX25hbWUpOgogICAgICAgIHNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbiA9IGV4dGVuc2lvbl9uYW1lCiAgICAgICAgcmV0dXJuIHNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbgoKICAgIGRlZiByZWdpc3Rlcl9mdW5jdGlvbihzZWxmLCBmdW5jKToKICAgICAgICBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnNbZnVuYy5fX25hbWVfX10gPSBmdW5jCiAgICAgICAgcmV0dXJuIGZ1bmMKCiAgICBkZWYgcmVnaXN0ZXJfZnVuY3Rpb25faWYoc2VsZiwgY29uZGl0aW9uKToKICAgICAgICBpZiBjb25kaXRpb246CiAgICAgICAgICAgIHJldHVybiBzZWxmLnJlZ2lzdGVyX2Z1bmN0aW9uCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIGxhbWJkYSBmdW5jdGlvbjogZnVuY3Rpb24KCiAgICBkZWYgcmVnaXN0ZXJfZnVuY3Rpb25fd2luZGxsKHNlbGYsIGZ1bmMpOgogICAgICAgIGlmIGhhc193aW5kbGw6CiAgICAgICAgICAgIHNlbGYucmVnaXN0ZXJfZnVuY3Rpb24oZnVuYykKICAgICAgICByZXR1cm4gZnVuYwoKICAgIGRlZiBhZGRfY2hhbm5lbChzZWxmLCBjaGFubmVsKToKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShjaGFubmVsLCBNZXRlcnByZXRlckNoYW5uZWwpOgogICAgICAgICAgICBkZWJ1Z19wcmludCgnWy1dIGNoYW5uZWwgb2JqZWN0IGlzIG5vdCBhbiBpbnN0YW5jZSBvZiBNZXRlcnByZXRlckNoYW5uZWwnKQogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ2ludmFsaWQgY2hhbm5lbCBvYmplY3QnKQogICAgICAgIGlkeCA9IHNlbGYubmV4dF9jaGFubmVsX2lkCiAgICAgICAgc2VsZi5jaGFubmVsc1tpZHhdID0gY2hhbm5lbAogICAgICAgIGRlYnVnX3ByaW50KCdbKl0gYWRkZWQgY2hhbm5lbCBpZDogJyArIHN0cihpZHgpICsgJyB0eXBlOiAnICsgY2hhbm5lbC5fX2NsYXNzX18uX19uYW1lX18pCiAgICAgICAgc2VsZi5uZXh0X2NoYW5uZWxfaWQgKz0gMQogICAgICAgIHJldHVybiBpZHgKCiAgICBkZWYgYWRkX3Byb2Nlc3Moc2VsZiwgcHJvY2Vzcyk6CiAgICAgICAgaWR4ID0gc2VsZi5uZXh0X3Byb2Nlc3NfaWQKICAgICAgICBzZWxmLnByb2Nlc3Nlc1tpZHhdID0gcHJvY2VzcwogICAgICAgIGRlYnVnX3ByaW50KCdbKl0gYWRkZWQgcHJvY2VzcyBpZDogJyArIHN0cihpZHgpKQogICAgICAgIHNlbGYubmV4dF9wcm9jZXNzX2lkICs9IDEKICAgICAgICByZXR1cm4gaWR4CgogICAgZGVmIGdldF9wYWNrZXQoc2VsZik6CiAgICAgICAgcGt0ID0gc2VsZi50cmFuc3BvcnQuZ2V0X3BhY2tldCgpCiAgICAgICAgaWYgcGt0IGlzIE5vbmUgYW5kIHNlbGYudHJhbnNwb3J0LnNob3VsZF9yZXRpcmU6CiAgICAgICAgICAgIHNlbGYudHJhbnNwb3J0X2NoYW5nZSgpCiAgICAgICAgcmV0dXJuIHBrdAoKICAgIGRlZiBzZW5kX3BhY2tldChzZWxmLCBwYWNrZXQpOgogICAgICAgIHNlbmRfc3VjY2VlZGVkID0gc2VsZi50cmFuc3BvcnQuc2VuZF9wYWNrZXQocGFja2V0KQogICAgICAgIGlmIG5vdCBzZW5kX3N1Y2NlZWRlZCBhbmQgc2VsZi50cmFuc3BvcnQuc2hvdWxkX3JldGlyZToKICAgICAgICAgICAgc2VsZi50cmFuc3BvcnRfY2hhbmdlKCkKICAgICAgICByZXR1cm4gc2VuZF9zdWNjZWVkZWQKCiAgICBAcHJvcGVydHkKICAgIGRlZiBzZXNzaW9uX2hhc19leHBpcmVkKHNlbGYpOgogICAgICAgIGlmIHNlbGYuc2Vzc2lvbl9leHBpcnlfdGltZSA9PSAwOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gdGltZS50aW1lKCkgPiBzZWxmLnNlc3Npb25fZXhwaXJ5X2VuZAoKICAgIGRlZiB0cmFuc3BvcnRfYWRkKHNlbGYsIG5ld190cmFuc3BvcnQpOgogICAgICAgIG5ld19wb3NpdGlvbiA9IHNlbGYudHJhbnNwb3J0cy5pbmRleChzZWxmLnRyYW5zcG9ydCkKICAgICAgICBzZWxmLnRyYW5zcG9ydHMuaW5zZXJ0KG5ld19wb3NpdGlvbiwgbmV3X3RyYW5zcG9ydCkKCiAgICBkZWYgdHJhbnNwb3J0X2NoYW5nZShzZWxmLCBuZXdfdHJhbnNwb3J0PU5vbmUpOgogICAgICAgIGlmIG5ld190cmFuc3BvcnQgaXMgTm9uZToKICAgICAgICAgICAgbmV3X3RyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0X25leHQoKQogICAgICAgIHNlbGYudHJhbnNwb3J0LmRlYWN0aXZhdGUoKQogICAgICAgIGRlYnVnX3ByaW50KCdbKl0gY2hhbmdpbmcgdHJhbnNwb3J0IHRvOiAnICsgbmV3X3RyYW5zcG9ydC51cmwpCiAgICAgICAgd2hpbGUgbm90IG5ld190cmFuc3BvcnQuYWN0aXZhdGUoKToKICAgICAgICAgICAgbmV3X3RyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0X25leHQobmV3X3RyYW5zcG9ydCkKICAgICAgICAgICAgZGVidWdfcHJpbnQoJ1sqXSBjaGFuZ2luZyB0cmFuc3BvcnQgdG86ICcgKyBuZXdfdHJhbnNwb3J0LnVybCkKICAgICAgICBzZWxmLnRyYW5zcG9ydCA9IG5ld190cmFuc3BvcnQKCiAgICBkZWYgdHJhbnNwb3J0X25leHQoc2VsZiwgY3VycmVudF90cmFuc3BvcnQ9Tm9uZSk6CiAgICAgICAgaWYgY3VycmVudF90cmFuc3BvcnQgaXMgTm9uZToKICAgICAgICAgICAgY3VycmVudF90cmFuc3BvcnQgPSBzZWxmLnRyYW5zcG9ydAogICAgICAgIG5ld19pZHggPSBzZWxmLnRyYW5zcG9ydHMuaW5kZXgoY3VycmVudF90cmFuc3BvcnQpICsgMQogICAgICAgIGlmIG5ld19pZHggPT0gbGVuKHNlbGYudHJhbnNwb3J0cyk6CiAgICAgICAgICAgIG5ld19pZHggPSAwCiAgICAgICAgcmV0dXJuIHNlbGYudHJhbnNwb3J0c1tuZXdfaWR4XQoKICAgIGRlZiB0cmFuc3BvcnRfcHJldihzZWxmLCBjdXJyZW50X3RyYW5zcG9ydD1Ob25lKToKICAgICAgICBpZiBjdXJyZW50X3RyYW5zcG9ydCBpcyBOb25lOgogICAgICAgICAgICBjdXJyZW50X3RyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0CiAgICAgICAgbmV3X2lkeCA9IHNlbGYudHJhbnNwb3J0cy5pbmRleChjdXJyZW50X3RyYW5zcG9ydCkgLSAxCiAgICAgICAgaWYgbmV3X2lkeCA9PSAtMToKICAgICAgICAgICAgbmV3X2lkeCA9IGxlbihzZWxmLnRyYW5zcG9ydHMpIC0gMQogICAgICAgIHJldHVybiBzZWxmLnRyYW5zcG9ydHNbbmV3X2lkeF0KCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgIHdoaWxlIHNlbGYucnVubmluZyBhbmQgbm90IHNlbGYuc2Vzc2lvbl9oYXNfZXhwaXJlZDoKICAgICAgICAgICAgcmVxdWVzdCA9IHNlbGYuZ2V0X3BhY2tldCgpCiAgICAgICAgICAgIGlmIHJlcXVlc3Q6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuY3JlYXRlX3Jlc3BvbnNlKHJlcXVlc3QpCiAgICAgICAgICAgICAgICBpZiByZXNwb25zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfcGFja2V0KHJlc3BvbnNlKQogICAgICAgICAgICAgICAgaWYgc2VsZi5fdHJhbnNwb3J0X3NsZWVwOgogICAgICAgICAgICAgICAgICAgIHNlbGYudHJhbnNwb3J0LmRlYWN0aXZhdGUoKQogICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc2VsZi5fdHJhbnNwb3J0X3NsZWVwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3RyYW5zcG9ydF9zbGVlcCA9IE5vbmUKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi50cmFuc3BvcnQuYWN0aXZhdGUoKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc3BvcnRfY2hhbmdlKCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAjIGl0ZXJhdGUgb3ZlciB0aGUga2V5cyBiZWNhdXNlIHNlbGYuY2hhbm5lbHMgY291bGQgYmUgbW9kaWZpZWQgaWYgb25lIGlzIGNsb3NlZAogICAgICAgICAgICBjaGFubmVsX2lkcyA9IGxpc3Qoc2VsZi5jaGFubmVscy5rZXlzKCkpCiAgICAgICAgICAgIGZvciBjaGFubmVsX2lkIGluIGNoYW5uZWxfaWRzOgogICAgICAgICAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICAgICAgICAgIGRhdGEgPSBieXRlcygpCiAgICAgICAgICAgICAgICB3cml0ZV9yZXF1ZXN0X3BhcnRzID0gW10KICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoY2hhbm5lbCwgTWV0ZXJwcmV0ZXJQcm9jZXNzKToKICAgICAgICAgICAgICAgICAgICBpZiBub3QgY2hhbm5lbF9pZCBpbiBzZWxmLmludGVyYWN0X2NoYW5uZWxzOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIHByb2NfaCA9IGNoYW5uZWwucHJvY19oCiAgICAgICAgICAgICAgICAgICAgaWYgcHJvY19oLnN0ZGVycl9yZWFkZXIuaXNfcmVhZF9yZWFkeSgpOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gcHJvY19oLnN0ZGVycl9yZWFkZXIucmVhZCgpCiAgICAgICAgICAgICAgICAgICAgZWxpZiBwcm9jX2guc3Rkb3V0X3JlYWRlci5pc19yZWFkX3JlYWR5KCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBwcm9jX2guc3Rkb3V0X3JlYWRlci5yZWFkKCkKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBjaGFubmVsLmlzX2FsaXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGFuZGxlX2RlYWRfcmVzb3VyY2VfY2hhbm5lbChjaGFubmVsX2lkKQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyU29ja2V0VENQQ2xpZW50KToKICAgICAgICAgICAgICAgICAgICB3aGlsZSBzZWxlY3Quc2VsZWN0KFtjaGFubmVsLmZpbGVubygpXSwgW10sIFtdLCAwKVswXToKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZCA9IGNoYW5uZWwucmVhZCgxKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZCA9IGJ5dGVzKCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGQpID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhhbmRsZV9kZWFkX3Jlc291cmNlX2NoYW5uZWwoY2hhbm5lbF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gZAogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyU29ja2V0VENQU2VydmVyKToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxlY3Quc2VsZWN0KFtjaGFubmVsLmZpbGVubygpXSwgW10sIFtdLCAwKVswXToKICAgICAgICAgICAgICAgICAgICAgICAgKGNsaWVudF9zb2NrLCBjbGllbnRfYWRkcikgPSBjaGFubmVsLnNvY2suYWNjZXB0KCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyX2FkZHIgPSBjaGFubmVsLnNvY2suZ2V0c29ja25hbWUoKQogICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRfY2hhbm5lbF9pZCA9IHNlbGYuYWRkX2NoYW5uZWwoTWV0ZXJwcmV0ZXJTb2NrZXRUQ1BDbGllbnQoY2xpZW50X3NvY2spKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfcGFja2V0KHRsdl9wYWNrX3JlcXVlc3QoJ3RjcF9jaGFubmVsX29wZW4nLCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7J3R5cGUnOiBUTFZfVFlQRV9DSEFOTkVMX0lELCAndmFsdWUnOiBjbGllbnRfY2hhbm5lbF9pZH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7J3R5cGUnOiBUTFZfVFlQRV9DSEFOTkVMX1BBUkVOVElELCAndmFsdWUnOiBjaGFubmVsX2lkfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX0xPQ0FMX0hPU1QsICd2YWx1ZSc6IGluZXRfcHRvbihjaGFubmVsLnNvY2suZmFtaWx5LCBzZXJ2ZXJfYWRkclswXSl9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfTE9DQUxfUE9SVCwgJ3ZhbHVlJzogc2VydmVyX2FkZHJbMV19LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfUEVFUl9IT1NULCAndmFsdWUnOiBpbmV0X3B0b24oY2xpZW50X3NvY2suZmFtaWx5LCBjbGllbnRfYWRkclswXSl9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfUEVFUl9QT1JULCAndmFsdWUnOiBjbGllbnRfYWRkclsxXX0sCiAgICAgICAgICAgICAgICAgICAgICAgIF0pKQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyU29ja2V0VURQQ2xpZW50KToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxlY3Quc2VsZWN0KFtjaGFubmVsLmZpbGVubygpXSwgW10sIFtdLCAwKVswXToKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSwgcGVlcl9hZGRyZXNzID0gY2hhbm5lbC5zb2NrLnJlY3Zmcm9tKDY1NTM1KQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oYW5kbGVfZGVhZF9yZXNvdXJjZV9jaGFubmVsKGNoYW5uZWxfaWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZV9yZXF1ZXN0X3BhcnRzLmV4dGVuZChbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfUEVFUl9IT1NULCAndmFsdWUnOiBwZWVyX2FkZHJlc3NbMF19LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX1BFRVJfUE9SVCwgJ3ZhbHVlJzogcGVlcl9hZGRyZXNzWzFdfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICAgICAgICAgIHdyaXRlX3JlcXVlc3RfcGFydHMuZXh0ZW5kKFsKICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfQ0hBTk5FTF9JRCwgJ3ZhbHVlJzogY2hhbm5lbF9pZH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX0NIQU5ORUxfREFUQSwgJ3ZhbHVlJzogZGF0YX0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX0xFTkdUSCwgJ3ZhbHVlJzogbGVuKGRhdGEpfSwKICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9wYWNrZXQodGx2X3BhY2tfcmVxdWVzdCgnY29yZV9jaGFubmVsX3dyaXRlJywgd3JpdGVfcmVxdWVzdF9wYXJ0cykpCgogICAgZGVmIGhhbmRsZV9kZWFkX3Jlc291cmNlX2NoYW5uZWwoc2VsZiwgY2hhbm5lbF9pZCk6CiAgICAgICAgZGVsIHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICBpZiBjaGFubmVsX2lkIGluIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHM6CiAgICAgICAgICAgIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHMucmVtb3ZlKGNoYW5uZWxfaWQpCiAgICAgICAgc2VsZi5zZW5kX3BhY2tldCh0bHZfcGFja19yZXF1ZXN0KCdjb3JlX2NoYW5uZWxfY2xvc2UnLCBbCiAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX0NIQU5ORUxfSUQsICd2YWx1ZSc6IGNoYW5uZWxfaWR9LAogICAgICAgIF0pKQoKICAgIGRlZiBfY29yZV9zZXRfdXVpZChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgbmV3X3V1aWQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9VVUlEKQogICAgICAgIGlmIG5ld191dWlkOgogICAgICAgICAgICBQQVlMT0FEX1VVSUQgPSBiaW5hc2NpaS5iMmFfaGV4KG5ld191dWlkWyd2YWx1ZSddKQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV9lbnVtZXh0Y21kKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBleHRlbnNpb25fbmFtZSA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1NUUklORylbJ3ZhbHVlJ10KICAgICAgICBmb3IgZnVuY19uYW1lIGluIHNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9ucy5rZXlzKCk6CiAgICAgICAgICAgIGlmIGZ1bmNfbmFtZS5zcGxpdCgnXycsIDEpWzBdID09IGV4dGVuc2lvbl9uYW1lOgogICAgICAgICAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfU1RSSU5HLCBmdW5jX25hbWUpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX2dldF9zZXNzaW9uX2d1aWQoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX1NFU1NJT05fR1VJRCwgYmluYXNjaWkuYTJiX2hleChieXRlcyhTRVNTSU9OX0dVSUQsICdVVEYtOCcpKSkKICAgICAgICByZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCiAgICBkZWYgX2NvcmVfc2V0X3Nlc3Npb25fZ3VpZChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgbmV3X2d1aWQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9TRVNTSU9OX0dVSUQpCiAgICAgICAgaWYgbmV3X2d1aWQ6CiAgICAgICAgICAgIFNFU1NJT05fR1VJRCA9IGJpbmFzY2lpLmIyYV9oZXgobmV3X2d1aWRbJ3ZhbHVlJ10pCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX21hY2hpbmVfaWQoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIHNlcmlhbCA9ICcnCiAgICAgICAgbWFjaGluZV9uYW1lID0gcGxhdGZvcm0udW5hbWUoKVsxXQogICAgICAgIGlmIGhhc193aW5kbGw6CiAgICAgICAgICAgIGZyb20gY3R5cGVzIGltcG9ydCB3aW50eXBlcwoKICAgICAgICAgICAgazMyID0gY3R5cGVzLndpbmRsbC5rZXJuZWwzMgogICAgICAgICAgICBzeXNfZGlyID0gY3R5cGVzLmNyZWF0ZV91bmljb2RlX2J1ZmZlcigyNjApCiAgICAgICAgICAgIGlmIG5vdCBrMzIuR2V0U3lzdGVtRGlyZWN0b3J5VyhjdHlwZXMuYnlyZWYoc3lzX2RpciksIDI2MCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRV9XSU5ET1dTCgogICAgICAgICAgICB2b2xfYnVmID0gY3R5cGVzLmNyZWF0ZV91bmljb2RlX2J1ZmZlcigyNjApCiAgICAgICAgICAgIGZzX2J1ZiA9IGN0eXBlcy5jcmVhdGVfdW5pY29kZV9idWZmZXIoMjYwKQogICAgICAgICAgICBzZXJpYWxfbnVtID0gd2ludHlwZXMuRFdPUkQoMCkKCiAgICAgICAgICAgIGlmIG5vdCBrMzIuR2V0Vm9sdW1lSW5mb3JtYXRpb25XKGN0eXBlcy5jX3djaGFyX3Aoc3lzX2Rpci52YWx1ZVs6M10pLAogICAgICAgICAgICAgICAgICAgIHZvbF9idWYsIGN0eXBlcy5zaXplb2Yodm9sX2J1ZiksIGN0eXBlcy5ieXJlZihzZXJpYWxfbnVtKSwgTm9uZSwKICAgICAgICAgICAgICAgICAgICBOb25lLCBmc19idWYsIGN0eXBlcy5zaXplb2YoZnNfYnVmKSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRV9XSU5ET1dTCiAgICAgICAgICAgIHNlcmlhbF9udW0gPSBzZXJpYWxfbnVtLnZhbHVlCiAgICAgICAgICAgIHNlcmlhbCA9ICIlMDR4IiAlICgoc2VyaWFsX251bSA+PiAxNikgJiAweGZmZmYpICsgJy0nICIlMDR4IiAlIChzZXJpYWxfbnVtICYgMHhmZmZmKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlcmlhbCA9IGdldF9oZGRfbGFiZWwoKQoKICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9NQUNISU5FX0lELCAiJXM6JXMiICUgKHNlcmlhbCwgbWFjaGluZV9uYW1lKSkKICAgICAgICByZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCiAgICBkZWYgX2NvcmVfbmF0aXZlX2FyY2goc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX1NUUklORywgZ2V0X25hdGl2ZV9hcmNoKCkpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX3BhdGNoX3VybChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uoc2VsZi50cmFuc3BvcnQsIEh0dHBUcmFuc3BvcnQpOgogICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKICAgICAgICBuZXdfdXJpX3BhdGggPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19VUkwpWyd2YWx1ZSddCiAgICAgICAgaWYgbm90IHNlbGYudHJhbnNwb3J0LnBhdGNoX3VyaV9wYXRoKG5ld191cmlfcGF0aCk6CiAgICAgICAgICAgIHJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV9sb2FkbGliKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBkYXRhX3RsdiA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0RBVEEpCiAgICAgICAgaWYgKGRhdGFfdGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX0NPTVBSRVNTRUQpID09IFRMVl9NRVRBX1RZUEVfQ09NUFJFU1NFRDoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCgogICAgICAgIHNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbiA9IE5vbmUKICAgICAgICBzeW1ib2xzX2Zvcl9leHRlbnNpb25zID0geydtZXRlcnByZXRlcic6c2VsZn0KICAgICAgICBzeW1ib2xzX2Zvcl9leHRlbnNpb25zLnVwZGF0ZShFWFBPUlRFRF9TWU1CT0xTKQogICAgICAgIGkgPSBjb2RlLkludGVyYWN0aXZlSW50ZXJwcmV0ZXIoc3ltYm9sc19mb3JfZXh0ZW5zaW9ucykKICAgICAgICBpLnJ1bmNvZGUoY29tcGlsZShkYXRhX3RsdlsndmFsdWUnXSwgJycsICdleGVjJykpCiAgICAgICAgZXh0ZW5zaW9uX25hbWUgPSBzZWxmLmxhc3RfcmVnaXN0ZXJlZF9leHRlbnNpb24KCiAgICAgICAgaWYgZXh0ZW5zaW9uX25hbWU6CiAgICAgICAgICAgIGNoZWNrX2V4dGVuc2lvbiA9IGxhbWJkYSB4OiB4LnN0YXJ0c3dpdGgoZXh0ZW5zaW9uX25hbWUpCiAgICAgICAgICAgIGxpYl9tZXRob2RzID0gbGlzdChmaWx0ZXIoY2hlY2tfZXh0ZW5zaW9uLCBsaXN0KHNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9ucy5rZXlzKCkpKSkKICAgICAgICAgICAgZm9yIG1ldGhvZCBpbiBsaWJfbWV0aG9kczoKICAgICAgICAgICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX01FVEhPRCwgbWV0aG9kKQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV9zaHV0ZG93bihzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfQk9PTCwgVHJ1ZSkKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV90cmFuc3BvcnRfYWRkKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBuZXdfdHJhbnNwb3J0ID0gVHJhbnNwb3J0LmZyb21fcmVxdWVzdChyZXF1ZXN0KQogICAgICAgIHNlbGYudHJhbnNwb3J0X2FkZChuZXdfdHJhbnNwb3J0KQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV90cmFuc3BvcnRfY2hhbmdlKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBuZXdfdHJhbnNwb3J0ID0gVHJhbnNwb3J0LmZyb21fcmVxdWVzdChyZXF1ZXN0KQogICAgICAgIHNlbGYudHJhbnNwb3J0X2FkZChuZXdfdHJhbnNwb3J0KQogICAgICAgIHNlbGYuc2VuZF9wYWNrZXQocmVzcG9uc2UgKyB0bHZfcGFjayhUTFZfVFlQRV9SRVNVTFQsIEVSUk9SX1NVQ0NFU1MpKQogICAgICAgIHNlbGYudHJhbnNwb3J0X2NoYW5nZShuZXdfdHJhbnNwb3J0KQogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9jb3JlX3RyYW5zcG9ydF9saXN0KHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBpZiBzZWxmLnNlc3Npb25fZXhwaXJ5X3RpbWUgPiAwOgogICAgICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9UUkFOU19TRVNTSU9OX0VYUCwgc2VsZi5zZXNzaW9uX2V4cGlyeV9lbmQgLSB0aW1lLnRpbWUoKSkKICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9UUkFOU19HUk9VUCwgc2VsZi50cmFuc3BvcnQudGx2X3BhY2tfdHJhbnNwb3J0X2dyb3VwKCkpCgogICAgICAgIHRyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0X25leHQoKQogICAgICAgIHdoaWxlIHRyYW5zcG9ydCAhPSBzZWxmLnRyYW5zcG9ydDoKICAgICAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfR1JPVVAsIHRyYW5zcG9ydC50bHZfcGFja190cmFuc3BvcnRfZ3JvdXAoKSkKICAgICAgICAgICAgdHJhbnNwb3J0ID0gc2VsZi50cmFuc3BvcnRfbmV4dCh0cmFuc3BvcnQpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX3RyYW5zcG9ydF9uZXh0KHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBuZXdfdHJhbnNwb3J0ID0gc2VsZi50cmFuc3BvcnRfbmV4dCgpCiAgICAgICAgaWYgbmV3X3RyYW5zcG9ydCA9PSBzZWxmLnRyYW5zcG9ydDoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgc2VsZi5zZW5kX3BhY2tldChyZXNwb25zZSArIHRsdl9wYWNrKFRMVl9UWVBFX1JFU1VMVCwgRVJST1JfU1VDQ0VTUykpCiAgICAgICAgc2VsZi50cmFuc3BvcnRfY2hhbmdlKG5ld190cmFuc3BvcnQpCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgX2NvcmVfdHJhbnNwb3J0X3ByZXYoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIG5ld190cmFuc3BvcnQgPSBzZWxmLnRyYW5zcG9ydF9wcmV2KCkKICAgICAgICBpZiBuZXdfdHJhbnNwb3J0ID09IHNlbGYudHJhbnNwb3J0OgogICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKICAgICAgICBzZWxmLnNlbmRfcGFja2V0KHJlc3BvbnNlICsgdGx2X3BhY2soVExWX1RZUEVfUkVTVUxULCBFUlJPUl9TVUNDRVNTKSkKICAgICAgICBzZWxmLnRyYW5zcG9ydF9jaGFuZ2UobmV3X3RyYW5zcG9ydCkKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBfY29yZV90cmFuc3BvcnRfcmVtb3ZlKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICB1cmwgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19VUkwpWyd2YWx1ZSddCiAgICAgICAgaWYgc2VsZi50cmFuc3BvcnQudXJsID09IHVybDoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgdHJhbnNwb3J0X2ZvdW5kID0gRmFsc2UKICAgICAgICBmb3IgdHJhbnNwb3J0IGluIHNlbGYudHJhbnNwb3J0czoKICAgICAgICAgICAgaWYgdHJhbnNwb3J0LnVybCA9PSB1cmw6CiAgICAgICAgICAgICAgICB0cmFuc3BvcnRfZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGlmIHRyYW5zcG9ydF9mb3VuZDoKICAgICAgICAgICAgc2VsZi50cmFuc3BvcnRzLnJlbW92ZSh0cmFuc3BvcnQpCiAgICAgICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQogICAgICAgIHJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV90cmFuc3BvcnRfc2V0X3RpbWVvdXRzKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICB0aW1lb3V0X3ZhbHVlID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfVFJBTlNfU0VTU0lPTl9FWFApLmdldCgndmFsdWUnKQogICAgICAgIGlmIG5vdCB0aW1lb3V0X3ZhbHVlIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuc2Vzc2lvbl9leHBpcnlfdGltZSA9IHRpbWVvdXRfdmFsdWUKICAgICAgICAgICAgc2VsZi5zZXNzaW9uX2V4cGlyeV9lbmQgPSB0aW1lLnRpbWUoKSArIHNlbGYuc2Vzc2lvbl9leHBpcnlfdGltZQogICAgICAgIHRpbWVvdXRfdmFsdWUgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19DT01NX1RJTUVPVVQpLmdldCgndmFsdWUnKQogICAgICAgIGlmIHRpbWVvdXRfdmFsdWU6CiAgICAgICAgICAgIHNlbGYudHJhbnNwb3J0LmNvbW11bmljYXRpb25fdGltZW91dCA9IHRpbWVvdXRfdmFsdWUKICAgICAgICByZXRyeV92YWx1ZSA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX1JFVFJZX1RPVEFMKS5nZXQoJ3ZhbHVlJykKICAgICAgICBpZiByZXRyeV92YWx1ZToKICAgICAgICAgICAgc2VsZi50cmFuc3BvcnQucmV0cnlfdG90YWwgPSByZXRyeV92YWx1ZQogICAgICAgIHJldHJ5X3ZhbHVlID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfVFJBTlNfUkVUUllfV0FJVCkuZ2V0KCd2YWx1ZScpCiAgICAgICAgaWYgcmV0cnlfdmFsdWU6CiAgICAgICAgICAgIHNlbGYudHJhbnNwb3J0LnJldHJ5X3dhaXQgPSByZXRyeV92YWx1ZQoKICAgICAgICBpZiBzZWxmLnNlc3Npb25fZXhwaXJ5X3RpbWUgPiAwOgogICAgICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9UUkFOU19TRVNTSU9OX0VYUCwgc2VsZi5zZXNzaW9uX2V4cGlyeV9lbmQgLSB0aW1lLnRpbWUoKSkKICAgICAgICByZXNwb25zZSArPSBzZWxmLnRyYW5zcG9ydC50bHZfcGFja190aW1lb3V0cygpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX3RyYW5zcG9ydF9zbGVlcChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgc2Vjb25kcyA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX0NPTU1fVElNRU9VVClbJ3ZhbHVlJ10KICAgICAgICBzZWxmLnNlbmRfcGFja2V0KHJlc3BvbnNlICsgdGx2X3BhY2soVExWX1RZUEVfUkVTVUxULCBFUlJPUl9TVUNDRVNTKSkKICAgICAgICBpZiBzZWNvbmRzOgogICAgICAgICAgICBzZWxmLl90cmFuc3BvcnRfc2xlZXAgPSBzZWNvbmRzCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX2NoYW5uZWxfb3BlbihzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF90eXBlID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfQ0hBTk5FTF9UWVBFKQogICAgICAgIGhhbmRsZXIgPSAnY2hhbm5lbF9vcGVuXycgKyBjaGFubmVsX3R5cGVbJ3ZhbHVlJ10KICAgICAgICBpZiBoYW5kbGVyIG5vdCBpbiBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnM6CiAgICAgICAgICAgIGRlYnVnX3ByaW50KCdbLV0gY29yZV9jaGFubmVsX29wZW4gbWlzc2luZyBoYW5kbGVyOiAnICsgaGFuZGxlcikKICAgICAgICAgICAgcmV0dXJuIGVycm9yX3Jlc3VsdChOb3RJbXBsZW1lbnRlZEVycm9yKSwgcmVzcG9uc2UKICAgICAgICBkZWJ1Z19wcmludCgnWypdIGNvcmVfY2hhbm5lbF9vcGVuIGRpc3BhdGNoaW5nIHRvIGhhbmRsZXI6ICcgKyBoYW5kbGVyKQogICAgICAgIGhhbmRsZXIgPSBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnNbaGFuZGxlcl0KICAgICAgICByZXR1cm4gaGFuZGxlcihyZXF1ZXN0LCByZXNwb25zZSkKCiAgICBkZWYgX2NvcmVfY2hhbm5lbF9jbG9zZShzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF9pZCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfSUQpWyd2YWx1ZSddCiAgICAgICAgaWYgY2hhbm5lbF9pZCBub3QgaW4gc2VsZi5jaGFubmVsczoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICBzdGF0dXMsIHJlc3BvbnNlID0gY2hhbm5lbC5jb3JlX2Nsb3NlKHJlcXVlc3QsIHJlc3BvbnNlKQogICAgICAgIGlmIHN0YXR1cyA9PSBFUlJPUl9TVUNDRVNTOgogICAgICAgICAgICBkZWwgc2VsZi5jaGFubmVsc1tjaGFubmVsX2lkXQogICAgICAgICAgICBpZiBjaGFubmVsX2lkIGluIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHM6CiAgICAgICAgICAgICAgICBzZWxmLmludGVyYWN0X2NoYW5uZWxzLnJlbW92ZShjaGFubmVsX2lkKQogICAgICAgICAgICBkZWJ1Z19wcmludCgnWypdIGNsb3NlZCBhbmQgcmVtb3ZlZCBjaGFubmVsIGlkOiAnICsgc3RyKGNoYW5uZWxfaWQpKQogICAgICAgIHJldHVybiBzdGF0dXMsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX2NoYW5uZWxfZW9mKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBjaGFubmVsX2lkID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfQ0hBTk5FTF9JRClbJ3ZhbHVlJ10KICAgICAgICBpZiBjaGFubmVsX2lkIG5vdCBpbiBzZWxmLmNoYW5uZWxzOgogICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKICAgICAgICBjaGFubmVsID0gc2VsZi5jaGFubmVsc1tjaGFubmVsX2lkXQogICAgICAgIHN0YXR1cywgcmVzcG9uc2UgPSBjaGFubmVsLmNvcmVfZW9mKHJlcXVlc3QsIHJlc3BvbnNlKQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKCiAgICBkZWYgX2NvcmVfY2hhbm5lbF9pbnRlcmFjdChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF9pZCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfSUQpWyd2YWx1ZSddCiAgICAgICAgaWYgY2hhbm5lbF9pZCBub3QgaW4gc2VsZi5jaGFubmVsczoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICB0b2dnbGUgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9CT09MKVsndmFsdWUnXQogICAgICAgIGlmIHRvZ2dsZToKICAgICAgICAgICAgaWYgY2hhbm5lbF9pZCBpbiBzZWxmLmludGVyYWN0X2NoYW5uZWxzOgogICAgICAgICAgICAgICAgc2VsZi5pbnRlcmFjdF9jaGFubmVscy5yZW1vdmUoY2hhbm5lbF9pZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHMuYXBwZW5kKGNoYW5uZWxfaWQpCiAgICAgICAgZWxpZiBjaGFubmVsX2lkIGluIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHM6CiAgICAgICAgICAgIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHMucmVtb3ZlKGNoYW5uZWxfaWQpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX2NoYW5uZWxfcmVhZChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF9pZCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfSUQpWyd2YWx1ZSddCiAgICAgICAgaWYgY2hhbm5lbF9pZCBub3QgaW4gc2VsZi5jaGFubmVsczoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICBzdGF0dXMsIHJlc3BvbnNlID0gY2hhbm5lbC5jb3JlX3JlYWQocmVxdWVzdCwgcmVzcG9uc2UpCiAgICAgICAgaWYgbm90IGNoYW5uZWwuaXNfYWxpdmUoKToKICAgICAgICAgICAgc2VsZi5oYW5kbGVfZGVhZF9yZXNvdXJjZV9jaGFubmVsKGNoYW5uZWxfaWQpCiAgICAgICAgcmV0dXJuIHN0YXR1cywgcmVzcG9uc2UKCiAgICBkZWYgX2NvcmVfY2hhbm5lbF93cml0ZShzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF9pZCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfSUQpWyd2YWx1ZSddCiAgICAgICAgaWYgY2hhbm5lbF9pZCBub3QgaW4gc2VsZi5jaGFubmVsczoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICBzdGF0dXMgPSBFUlJPUl9GQUlMVVJFCiAgICAgICAgaWYgY2hhbm5lbC5pc19hbGl2ZSgpOgogICAgICAgICAgICBzdGF0dXMsIHJlc3BvbnNlID0gY2hhbm5lbC5jb3JlX3dyaXRlKHJlcXVlc3QsIHJlc3BvbnNlKQogICAgICAgICMgZXZhbHVhdGUgY2hhbm5lbC5pc19hbGl2ZSgpIHR3aWNlIGJlY2F1c2UgaXQgY291bGQgaGF2ZSBjaGFuZ2VkCiAgICAgICAgaWYgbm90IGNoYW5uZWwuaXNfYWxpdmUoKToKICAgICAgICAgICAgc2VsZi5oYW5kbGVfZGVhZF9yZXNvdXJjZV9jaGFubmVsKGNoYW5uZWxfaWQpCiAgICAgICAgcmV0dXJuIHN0YXR1cywgcmVzcG9uc2UKCiAgICBkZWYgY3JlYXRlX3Jlc3BvbnNlKHNlbGYsIHJlcXVlc3QpOgogICAgICAgIHJlc3BvbnNlID0gc3RydWN0LnBhY2soJz5JJywgUEFDS0VUX1RZUEVfUkVTUE9OU0UpCiAgICAgICAgbWV0aG9kX3RsdiA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX01FVEhPRCkKICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhtZXRob2RfdGx2KQogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX1VVSUQsIGJpbmFzY2lpLmEyYl9oZXgoYnl0ZXMoUEFZTE9BRF9VVUlELCAnVVRGLTgnKSkpCgogICAgICAgIGhhbmRsZXJfbmFtZSA9IG1ldGhvZF90bHZbJ3ZhbHVlJ10KICAgICAgICBpZiBoYW5kbGVyX25hbWUgaW4gc2VsZi5leHRlbnNpb25fZnVuY3Rpb25zOgogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5leHRlbnNpb25fZnVuY3Rpb25zW2hhbmRsZXJfbmFtZV0KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGVidWdfcHJpbnQoJ1sqXSBydW5uaW5nIG1ldGhvZCAnICsgaGFuZGxlcl9uYW1lKQogICAgICAgICAgICAgICAgcmVzdWx0ID0gaGFuZGxlcihyZXF1ZXN0LCByZXNwb25zZSkKICAgICAgICAgICAgICAgIGlmIHJlc3VsdCBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgcmVzdWx0LCByZXNwb25zZSA9IHJlc3VsdAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgZGVidWdfdHJhY2ViYWNrKCdbLV0gbWV0aG9kICcgKyBoYW5kbGVyX25hbWUgKyAnIHJlc3VsdGVkIGluIGFuIGVycm9yJykKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGVycm9yX3Jlc3VsdCgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiByZXN1bHQgIT0gRVJST1JfU1VDQ0VTUzoKICAgICAgICAgICAgICAgICAgICBkZWJ1Z19wcmludCgnWy1dIG1ldGhvZCAnICsgaGFuZGxlcl9uYW1lICsgJyByZXN1bHRlZCBpbiBlcnJvcjogIycgKyBzdHIocmVzdWx0KSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBkZWJ1Z19wcmludCgnWy1dIG1ldGhvZCAnICsgaGFuZGxlcl9uYW1lICsgJyB3YXMgcmVxdWVzdGVkIGJ1dCBkb2VzIG5vdCBleGlzdCcpCiAgICAgICAgICAgIHJlc3VsdCA9IGVycm9yX3Jlc3VsdChOb3RJbXBsZW1lbnRlZEVycm9yKQoKICAgICAgICByZXFpZF90bHYgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9SRVFVRVNUX0lEKQogICAgICAgIGlmIG5vdCByZXFpZF90bHY6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKHJlcWlkX3RsdikKICAgICAgICByZXR1cm4gcmVzcG9uc2UgKyB0bHZfcGFjayhUTFZfVFlQRV9SRVNVTFQsIHJlc3VsdCkKCl90cnlfdG9fZm9yayA9IFRSWV9UT19GT1JLIGFuZCBoYXNhdHRyKG9zLCAnZm9yaycpCmlmIG5vdCBfdHJ5X3RvX2Zvcmsgb3IgKF90cnlfdG9fZm9yayBhbmQgb3MuZm9yaygpID09IDApOgogICAgaWYgaGFzYXR0cihvcywgJ3NldHNpZCcpOgogICAgICAgIHRyeToKICAgICAgICAgICAgb3Muc2V0c2lkKCkKICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgaWYgSFRUUF9DT05ORUNUSU9OX1VSTCBhbmQgaGFzX3VybGxpYjoKICAgICAgICB0cmFuc3BvcnQgPSBIdHRwVHJhbnNwb3J0KEhUVFBfQ09OTkVDVElPTl9VUkwsIHByb3h5PUhUVFBfUFJPWFksIHVzZXJfYWdlbnQ9SFRUUF9VU0VSX0FHRU5ULAogICAgICAgICAgICAgICAgaHR0cF9ob3N0PUhUVFBfSE9TVCwgaHR0cF9yZWZlcmVyPUhUVFBfUkVGRVJFUiwgaHR0cF9jb29raWU9SFRUUF9DT09LSUUpCiAgICBlbHNlOgogICAgICAgICMgUEFUQ0gtU0VUVVAtU1RBR0VMRVNTLVRDUC1TT0NLRVQgIwogICAgICAgIHRyYW5zcG9ydCA9IFRjcFRyYW5zcG9ydC5mcm9tX3NvY2tldChzKQogICAgbWV0ID0gUHl0aG9uTWV0ZXJwcmV0ZXIodHJhbnNwb3J0KQogICAgIyBQQVRDSC1TRVRVUC1UUkFOU1BPUlRTICMKICAgIG1ldC5ydW4oKQo=')))